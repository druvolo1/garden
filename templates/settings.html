<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings - Flow Meter Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <style>
        .calibration-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .calibration-row label {
            width: 150px;
            margin-right: 10px;
        }
        .calibration-row input {
            flex: 1;
            min-width: 150px;
            padding: 5px;
        }
        .relay-port-select {
            width: 100px;
        }
        .relay-sections {
            display: flex;
            justify-content: space-between;
            flex: 0 1 800px;
            gap: 20px;
        }
        .relay-assignments {
            width: 60%;
        }
        .relay-testing {
            width: 35%;
        }
        .relay-button.active {
            background-color: green;
            color: white;
        }
        main {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .data-container {
            flex: 0 1 400px;
            box-sizing: border-box;
        }
        h1, .subtitle {
            flex: 0 0 100%;
        }
        .feed-pump-options {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .feed-pump-options input[type="radio"] {
            margin-right: 5px;
        }
        .feed-pump-options label {
            margin-right: 15px;
        }
        .tooltip {
            margin-left: 10px;
            font-size: 0.8em;
            color: #888;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();

            // Handle USB assignment form submit
            const valveForm = document.getElementById('valve-relay-form');
            if (valveForm) {
                valveForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const device = document.getElementById('valve-relay-device')?.value;
                    if (device) {
                        saveUsbAssignment('valve_relay', device);
                    } else {
                        alert('Please select a device.');
                    }
                });
            }

            // Handle relay ports form submit
            const relayPortForm = document.getElementById('relay-port-form');
            if (relayPortForm) {
                relayPortForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const feedPort = parseInt(document.getElementById('feed-water-relay-port')?.value, 10);
                    const freshPort = parseInt(document.getElementById('fresh-water-relay-port')?.value, 10);
                    if (!isNaN(feedPort) && !isNaN(freshPort)) {
                        fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ relay_ports: { feed_water: feedPort, fresh_water: freshPort } })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('Relay ports saved successfully.');
                                    loadSettings();
                                } else {
                                    alert('Failed to save relay ports: ' + data.error);
                                }
                            })
                            .catch(error => console.error('Error saving relay ports:', error));
                    } else {
                        alert('Please select valid ports.');
                    }
                });
            }

            // Handle feed pump form submit
            const feedPumpForm = document.getElementById('feed-pump-form');
            if (feedPumpForm) {
                feedPumpForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const ip = document.getElementById('feed-pump-ip')?.value.trim();
                    const ioNumber = document.getElementById('feed-pump-io-number')?.value.trim();
                    const isIO = document.getElementById('feed-pump-io')?.checked;
                    const isShelly = document.getElementById('feed-pump-shelly')?.checked;

                    if (isIO && ioNumber) {
                        fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ feed_pump: { io_number: ioNumber, type: 'io' } })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('Feed pump settings saved successfully.');
                                    loadSettings();
                                } else {
                                    alert('Failed to save feed pump settings: ' + data.error);
                                }
                            })
                            .catch(error => console.error('Error saving feed pump settings:', error));
                    } else if (isShelly && ip) {
                        fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ feed_pump: { ip: ip, type: 'shelly' } })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    alert('Feed pump settings saved successfully.');
                                    loadSettings();
                                } else {
                                    alert('Failed to save feed pump settings: ' + data.error);
                                }
                            })
                            .catch(error => console.error('Error saving feed pump settings:', error));
                    } else {
                        alert('Please select a mode and provide a valid IO number or IP address.');
                    }
                });
            }

            // Handle feed pump mode toggle
            const ioRadio = document.getElementById('feed-pump-io');
            const shellyRadio = document.getElementById('feed-pump-shelly');
            const ipInput = document.getElementById('feed-pump-ip');
            const ioNumberInput = document.getElementById('feed-pump-io-number');
            if (ioRadio && shellyRadio && ipInput && ioNumberInput) {
                ioRadio.addEventListener('change', function() {
                    if (ioRadio.checked) {
                        ipInput.disabled = true;
                        ipInput.value = '';
                        ioNumberInput.disabled = false;
                    }
                });
                shellyRadio.addEventListener('change', function() {
                    if (shellyRadio.checked) {
                        ioNumberInput.disabled = true;
                        ioNumberInput.value = '';
                        ipInput.disabled = false;
                    }
                });
            }

            // Handle feed pump on/off buttons with debounce
            let lastClickTime = 0;
            const debounceTime = 500;

            const feedPumpOnButton = document.getElementById('feed-pump-on');
            if (feedPumpOnButton) {
                feedPumpOnButton.addEventListener('click', function(e) {
                    const now = Date.now();
                    if (now - lastClickTime < debounceTime) return;
                    lastClickTime = now;
                    turnOnFeedPump();
                });
            }

            const feedPumpOffButton = document.getElementById('feed-pump-off');
            if (feedPumpOffButton) {
                feedPumpOffButton.addEventListener('click', function(e) {
                    const now = Date.now();
                    if (now - lastClickTime < debounceTime) return;
                    lastClickTime = now;
                    turnOffFeedPump();
                });
            }

            // Handle drain flow settings form submit
            const drainFlowForm = document.getElementById('drain-flow-form');
            if (drainFlowForm) {
                drainFlowForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const activationFlow = parseFloat(document.getElementById('activation-flow-rate')?.value);
                    const minFlow = parseFloat(document.getElementById('min-flow-rate')?.value);
                    const activationDelay = parseInt(document.getElementById('activation-delay')?.value, 10);
                    const minFlowCheckDelay = parseInt(document.getElementById('min-flow-check-delay')?.value, 10);
                    const maxDrainTime = parseInt(document.getElementById('max-drain-time')?.value, 10);

                    if (isNaN(activationFlow) || isNaN(minFlow) || isNaN(activationDelay) || isNaN(minFlowCheckDelay) || isNaN(maxDrainTime)) {
                        alert('Please enter valid numbers for all drain flow settings.');
                        return;
                    }
                    if (minFlow >= activationFlow) {
                        alert('Minimum flow rate must be less than activation flow rate.');
                        return;
                    }
                    if (maxDrainTime <= 0) {
                        alert('Max drain time must be greater than 0.');
                        return;
                    }

                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            drain_flow_settings: {
                                activation_flow_rate: activationFlow,
                                min_flow_rate: minFlow,
                                activation_delay: activationDelay,
                                min_flow_check_delay: minFlowCheckDelay,
                                max_drain_time: maxDrainTime
                            }
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Drain flow settings saved successfully.');
                            } else {
                                alert('Failed to save drain flow settings: ' + data.error);
                            }
                        })
                        .catch(error => console.error('Error saving drain flow settings:', error));
                });
            }

            // Handle discord form
            const discordForm = document.getElementById('discord-form');
            if (discordForm) {
                discordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const enabled = document.getElementById('discord-enabled').checked;
                    const webhook = document.getElementById('discord-webhook-url').value.trim();
                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ discord_enabled: enabled, discord_webhook_url: webhook })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Discord settings saved.');
                            } else {
                                alert('Failed to save Discord settings: ' + data.error);
                            }
                        });
                });
            }

            // Discord test
            const discordTestForm = document.getElementById('discord-test-form');
            if (discordTestForm) {
                discordTestForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const message = document.getElementById('discord-test-message').value.trim();
                    fetch('/api/test_discord', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message })
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                        });
                });
            }

            // Similar for telegram

            const telegramForm = document.getElementById('telegram-form');
            if (telegramForm) {
                telegramForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const enabled = document.getElementById('telegram-enabled').checked;
                    const token = document.getElementById('telegram-bot-token').value.trim();
                    const chatId = document.getElementById('telegram-chat-id').value.trim();
                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegram_enabled: enabled, telegram_bot_token: token, telegram_chat_id: chatId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Telegram settings saved.');
                            } else {
                                alert('Failed to save Telegram settings: ' + data.error);
                            }
                        });
                });
            }

            const telegramTestForm = document.getElementById('telegram-test-form');
            if (telegramTestForm) {
                telegramTestForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const message = document.getElementById('telegram-test-message').value.trim();
                    fetch('/api/test_telegram', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message })
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                        });
                });
            }

            // Relay on/off
            function turnOnRelay(relay) {
                fetch('/api/valve_relay/on', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ relay: relay })
                });
            }

            function turnOffRelay(relay) {
                fetch('/api/valve_relay/off', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ relay: relay })
                });
            }

            // Feed pump on/off
            function turnOnFeedPump() {
                fetch('/api/feed_pump/on', { method: 'POST' });
            }

            function turnOffFeedPump() {
                fetch('/api/feed_pump/off', { method: 'POST' });
            }

            // Save calibration
            function saveCalibrationFactors() {
                const fresh = parseFloat(document.getElementById('fresh-cal').value);
                const feed = parseFloat(document.getElementById('feed-cal').value);
                const drain = parseFloat(document.getElementById('drain-cal').value);
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ calibration_factors: { fresh, feed, drain } })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Calibration saved.');
                        }
                    });
            }

            // Save nutrient conc
            function saveNutrientConcentration() {
                const conc = parseFloat(document.getElementById('nutrient-conc').value);
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nutrient_concentration: conc })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Nutrient concentration saved.');
                        }
                    });
            }

            // Load settings
            function loadSettings() {
                fetch('/api/settings')
                    .then(response => response.json())
                    .then(settings => {
                        // Calibration
                        document.getElementById('fresh-cal').value = settings.calibration_factors.fresh || '';
                        document.getElementById('feed-cal').value = settings.calibration_factors.feed || '';
                        document.getElementById('drain-cal').value = settings.calibration_factors.drain || '';

                        // Nutrient conc
                        document.getElementById('nutrient-conc').value = settings.nutrient_concentration || 1;

                        // Valve relay device
                        const select = document.getElementById('valve-relay-device');
                        select.innerHTML = '<option value="">Select a device</option>';
                        settings.usb_devices.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device;
                            option.text = device;
                            if (device === settings.usb_assignments.valve_relay) option.selected = true;
                            select.appendChild(option);
                        });

                        // Relay ports
                        document.getElementById('feed-water-relay-port').value = settings.relay_ports.feed_water || 1;
                        document.getElementById('fresh-water-relay-port').value = settings.relay_ports.fresh_water || 2;

                        // Feed pump
                        if (settings.feed_pump.type === 'io') {
                            document.getElementById('feed-pump-io').checked = true;
                            document.getElementById('feed-pump-io-number').value = settings.feed_pump.io_number || '';
                            ipInput.disabled = true;
                            ioNumberInput.disabled = false;
                        } else if (settings.feed_pump.type === 'shelly') {
                            document.getElementById('feed-pump-shelly').checked = true;
                            document.getElementById('feed-pump-ip').value = settings.feed_pump.ip || '';
                            ioNumberInput.disabled = true;
                            ipInput.disabled = false;
                        }

                        // Drain flow
                        document.getElementById('activation-flow-rate').value = settings.drain_flow_settings.activation_flow_rate || 0.2;
                        document.getElementById('min-flow-rate').value = settings.drain_flow_settings.min_flow_rate || 0.05;
                        document.getElementById('activation-delay').value = settings.drain_flow_settings.activation_delay || 5;
                        document.getElementById('min-flow-check-delay').value = settings.drain_flow_settings.min_flow_check_delay || 30;
                        document.getElementById('max-drain-time').value = settings.drain_flow_settings.max_drain_time || 600;

                        // Notifications
                        document.getElementById('discord-enabled').checked = settings.discord_enabled || false;
                        document.getElementById('discord-webhook-url').value = settings.discord_webhook_url || '';
                        document.getElementById('telegram-enabled').checked = settings.telegram_enabled || false;
                        document.getElementById('telegram-bot-token').value = settings.telegram_bot_token || '';
                        document.getElementById('telegram-chat-id').value = settings.telegram_chat_id || '';

                        // Application update
                        document.getElementById('current-version').innerText = settings.version || 'Unknown';

                        // Additional plants
                        const plantsList = document.getElementById('additional-plants-list');
                        plantsList.innerHTML = '';
                        (settings.additional_plants || []).forEach(ip => {
                            const div = document.createElement('div');
                            div.innerHTML = `${ip} <button onclick="removeAdditionalPlant('${ip}')">Remove</button>`;
                            plantsList.appendChild(div);
                        });

                        // Power controls
                        renderPowerOutlets(settings.power_controls || []);
                    })
                    .catch(error => console.error('Error loading settings:', error));
            }

            // Add additional plant
            function addAdditionalPlant() {
                const ip = document.getElementById('new-plant-ip').value.trim();
                if (ip) {
                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ additional_plants_add: ip })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                loadSettings();
                            }
                        });
                }
            }

            // Remove additional plant
            function removeAdditionalPlant(ip) {
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ additional_plants_remove: ip })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            loadSettings();
                        }
                    });
            }

            // Power outlets
            function renderPowerOutlets(power_controls) {
                const list = document.getElementById('power-outlets-list');
                list.innerHTML = '';
                power_controls.forEach(outlet => {
                    const card = document.createElement('div');
                    card.className = 'data-box';
                    card.innerHTML = `
                        <p>IP: ${outlet.ip}</p>
                        <label>Assigned Valves:</label>
                        <select id="valves-${outlet.ip}" multiple></select>
                        <button class="small-btn" onclick="saveValveAssignment('${outlet.ip}')">Save</button>
                        <button class="small-btn stop-btn" onclick="removePowerOutlet('${outlet.ip}')">Remove</button>
                    `;
                    list.appendChild(card);

                    retrieveValvesFromIP(outlet.ip).then(valves => {
                        const select = document.getElementById(`valves-${outlet.ip}`);
                        valves.forEach(v => {
                            const option = document.createElement('option');
                            option.value = v;
                            option.text = v;
                            if (outlet.valves.includes(v)) option.selected = true;
                            select.appendChild(option);
                        });
                    });
                });
            }

            function addPowerOutlet() {
                const ip = document.getElementById('new-outlet-ip').value.trim();
                if (ip) {
                    fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ power_controls: [...(settings.power_controls || []), {ip, valves: []}] })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Outlet added.');
                                loadSettings();
                            }
                        });
                }
            }

            function removePowerOutlet(ip) {
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ power_controls_remove: ip })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            loadSettings();
                        }
                    });
            }

            function retrieveValvesFromIP(ip) {
                return fetch(`/retrieve_valves?ip=${ip}`)
                    .then(response => response.json())
                    .then(data => data.valves || [])
                    .catch(() => []);
            }

            function saveValveAssignment(ip) {
                const select = document.getElementById(`valves-${ip}`);
                const valves = Array.from(select.selectedOptions).map(opt => opt.value);
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ power_controls_update: {ip, valves} })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Valve assignment saved.');
                        }
                    });
            }

            // Check for update
            function checkForUpdate() {
                const modal = document.getElementById('update-modal');
                const overlay = document.getElementById('overlay');
                const progress = document.getElementById('update-progress');
                const title = document.getElementById('update-title');
                const closeBtn = document.getElementById('close-modal');

                title.innerText = 'Checking for Update...';
                progress.innerHTML = '';
                modal.style.display = 'block';
                overlay.style.display = 'block';
                closeBtn.style.display = 'none';

                fetch('/api/check_update')
                    .then(response => response.json())
                    .then(data => {
                        if (data.update_available) {
                            title.innerText = 'Update Available';
                            progress.innerHTML = 'Starting update...<br>';
                            performUpdate();
                        } else {
                            title.innerText = 'No Update Available';
                            progress.innerHTML = 'Your application is up to date.';
                            closeBtn.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        title.innerText = 'Error Checking for Update';
                        progress.innerHTML = error;
                        closeBtn.style.display = 'block';
                    });
            }

            function performUpdate() {
                const progress = document.getElementById('update-progress');
                fetch('/api/update', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        progress.innerHTML += data.message + '<br>';
                        if (data.status === 'success') {
                            progress.innerHTML += 'Update complete. Reloading...';
                            setTimeout(() => location.reload(), 2000);
                        }
                    })
                    .catch(error => {
                        progress.innerHTML += 'Error: ' + error + '<br>';
                    });
            }

            function closeUpdateModal() {
                document.getElementById('update-modal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
            }

            // Save USB assignment
            function saveUsbAssignment(type, device) {
                fetch('/api/assign_usb', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type, device: device })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('USB assigned successfully.');
                            loadSettings();
                        } else {
                            alert('Failed to assign USB: ' + data.error);
                        }
                    });
            }
        });
    </script>
</head>
<body>
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/settings" class="active">Settings</a></li>
            <li><a href="/debug">Debug</a></li>
            <li><a href="/logs">Logs</a></li>
        </ul>
    </nav>

    <div id="update-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e1e1e; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; max-width: 80%; max-height: 80%; overflow-y: auto;">
        <h3 id="update-title">Updating Application...</h3>
        <div id="update-progress" style="margin: 10px 0; font-family: monospace; white-space: pre-wrap;"></div>
        <button id="close-modal" onclick="closeUpdateModal()" style="display: none;">Close</button>
    </div>
    <div id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;"></div>

    <main>
        <h1>Settings</h1>
        <p class="subtitle">Configure your flow meter monitor.</p>

        <div class="data-container">
            <h3>Plants to feed</h3>
            <div id="additional-plants-list">
                <!-- Populated by JS -->
            </div>
            <p>New IP / DNS:</p>
            <div class="valve-rename-cell">
                <input type="text" id="new-plant-ip" placeholder="e.g., 192.168.1.100 or plant2.local">
                <button class="small-btn" onclick="addAdditionalPlant()">+ Add</button>
            </div>
        </div>

        <div class="data-container">
            <h3>Flow Meter Calibration (pulses per gallon)</h3>
            <div class="calibration-row">
                <label>Fresh Water:</label>
                <input type="number" id="fresh-cal" step="0.001">
            </div>
            <div class="calibration-row">
                <label>Feed Water:</label>
                <input type="number" id="feed-cal" step="0.001">
            </div>
            <div class="calibration-row">
                <label>Drain:</label>
                <input type="number" id="drain-cal" step="0.001">
            </div>
            <button class="small-btn" onclick="saveCalibrationFactors()">Save Calibration Factors</button>
        </div>

        <div class="data-container">
            <h3>Nutrient Concentration</h3>
            <div class="calibration-row">
                <label>Concentration:</label>
                <input type="number" id="nutrient-conc" step="0.1" value="1">
            </div>
            <button class="small-btn" onclick="saveNutrientConcentration()">Save Nutrient Concentration</button>
        </div>

        <div class="data-container">
            <h3>Valve Relay Module</h3>
            <form id="valve-relay-form">
                <label for="valve-relay-device">Valve Relay Module:</label>
                <select id="valve-relay-device" name="valve-relay-device">
                    <option value="">Select a device</option>
                </select>
                <br><br>
                <button type="submit">Save Valve Relay Module</button>
            </form>
            <br>
            <button onclick="loadSettings()">Rescan USB Devices</button>
        </div>

        <div class="relay-sections">
            <div class="relay-assignments data-container">
                <h3>Valve Relay Port Assignments</h3>
                <form id="relay-port-form">
                    <label for="feed-water-relay-port">Feed Water Relay Port:</label>
                    <select id="feed-water-relay-port" class="relay-port-select">
                        <option value="1">Relay 1</option>
                        <option value="2">Relay 2</option>
                    </select>
                    <br><br>
                    <label for="fresh-water-relay-port">Fresh Water Relay Port:</label>
                    <select id="fresh-water-relay-port" class="relay-port-select">
                        <option value="1">Relay 1</option>
                        <option value="2">Relay 2</option>
                    </select>
                    <br><br>
                    <button type="submit">Save Relay Port Assignments</button>
                </form>
            </div>

            <div class="relay-testing data-container">
                <h3>Relay Testing</h3>
                <p>Relay 1:</p>
                <button id="relay-1-on" class="small-btn relay-button" onclick="turnOnRelay(1)">On</button>
                <button id="relay-1-off" class="small-btn relay-button" onclick="turnOffRelay(1)">Off</button>
                <br><br>
                <p>Relay 2:</p>
                <button id="relay-2-on" class="small-btn relay-button" onclick="turnOnRelay(2)">On</button>
                <button id="relay-2-off" class="small-btn relay-button" onclick="turnOffRelay(2)">Off</button>
            </div>
        </div>

        <div class="data-container">
            <h3>Nutrient Feed Pump</h3>
            <form id="feed-pump-form">
                <div class="feed-pump-options">
                    <label>Pump Control Mode:</label>
                    <input type="radio" id="feed-pump-io" name="feed-pump-type" value="io">
                    <label for="feed-pump-io">IO</label>
                    <input type="radio" id="feed-pump-shelly" name="feed-pump-type" value="shelly">
                    <label for="feed-pump-shelly">Shelly</label>
                </div>
                <div class="calibration-row" id="io-settings">
                    <label>IO Number:</label>
                    <input type="number" id="feed-pump-io-number" placeholder="e.g., 17" min="0">
                </div>
                <div class="calibration-row" id="shelly-settings">
                    <label>IP Address:</label>
                    <input type="text" id="feed-pump-ip" placeholder="e.g., 192.168.1.100">
                </div>
                <button type="submit">Save Feed Pump Settings</button>
            </form>
            <br>
            <button id="feed-pump-on" class="small-btn relay-button" onclick="turnOnFeedPump()">On</button>
            <button id="feed-pump-off" class="small-btn relay-button" onclick="turnOffFeedPump()">Off</button>
        </div>

        <div class="data-container">
            <h3>Power Controls</h3>
            <div id="power-outlets-list">
                <!-- Populated by JS -->
            </div>
            <p>New Outlet IP:</p>
            <div class="valve-rename-cell">
                <input type="text" id="new-outlet-ip" placeholder="e.g., 192.168.1.100">
                <button class="small-btn" onclick="addPowerOutlet()">+ Add</button>
            </div>
        </div>

        <div class="data-container">
            <h3>Drain Flow Settings</h3>
            <form id="drain-flow-form">
                <div class="calibration-row">
                    <label>Activation Flow Rate (Gal/min):</label>
                    <input type="number" id="activation-flow-rate" step="0.01" min="0" value="0.2">
                    <span class="tooltip">Minimum flow to confirm draining has started.</span>
                </div>
                <div class="calibration-row">
                    <label>Minimum Flow Rate (Gal/min):</label>
                    <input type="number" id="min-flow-rate" step="0.01" min="0" value="0.05">
                    <span class="tooltip">Threshold below which draining is considered stalled.</span>
                </div>
                <div class="calibration-row">
                    <label>Activation Delay (seconds):</label>
                    <input type="number" id="activation-delay" step="1" min="0" value="5">
                    <span class="tooltip">Delay after flow exceeds activation before monitoring min flow.</span>
                </div>
                <div class="calibration-row">
                    <label>Min Flow Check Delay (seconds):</label>
                    <input type="number" id="min-flow-check-delay" step="1" min="0" value="30">
                    <span class="tooltip">Delay after flow drops below min before aborting drain.</span>
                </div>
                <div class="calibration-row">
                    <label>Max Drain Time (seconds):</label>
                    <input type="number" id="max-drain-time" step="1" min="1" value="600">
                    <span class="tooltip">Maximum time allowed for draining before timing out.</span>
                </div>
                <button class="small-btn" type="submit">Save Drain Flow Settings</button>
            </form>
        </div>

        <div class="data-container">
            <h3>Notifications</h3>
            <div>
                <h4>Discord Settings</h4>
                <form id="discord-form">
                    <div class="calibration-row">
                        <label>Enable Discord Notifications:</label>
                        <input type="checkbox" id="discord-enabled">
                    </div>
                    <div class="calibration-row">
                        <label>Discord Webhook URL:</label>
                        <input type="text" id="discord-webhook-url" placeholder="https://discord.com/api/webhooks/...">
                    </div>
                    <button type="submit">Save Discord Settings</button>
                </form>
                <br>
                <form id="discord-test-form">
                    <h4>Test Discord Notification</h4>
                    <div class="calibration-row">
                        <label>Test Message:</label>
                        <input type="text" id="discord-test-message" placeholder="Enter test message">
                    </div>
                    <button type="submit">Send Test</button>
                </form>
            </div>
            <div>
                <h4>Telegram Settings</h4>
                <form id="telegram-form">
                    <div class="calibration-row">
                        <label>Enable Telegram Notifications:</label>
                        <input type="checkbox" id="telegram-enabled">
                    </div>
                    <div class="calibration-row">
                        <label>Telegram Bot Token:</label>
                        <input type="text" id="telegram-bot-token" placeholder="Enter bot token">
                    </div>
                    <div class="calibration-row">
                        <label>Telegram Chat ID:</label>
                        <input type="text" id="telegram-chat-id" placeholder="Enter chat ID">
                    </div>
                    <button type="submit">Save Telegram Settings</button>
                </form>
                <br>
                <form id="telegram-test-form">
                    <h4>Test Telegram Notification</h4>
                    <div class="calibration-row">
                        <label>Test Message:</label>
                        <input type="text" id="telegram-test-message" placeholder="Enter test message">
                    </div>
                    <button type="submit">Send Test</button>
                </form>
            </div>
        </div>

        <div class="data-container">
            <h3>Application Update</h3>
            <p>Current Version: <span id="current-version">Unknown</span></p>
            <button class="small-btn" onclick="checkForUpdate()">Check for Update</button>
            <p id="update-status"></p>
        </div>
    </main>
</body>
</html>