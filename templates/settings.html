<!DOCTYPE html>
<html lang="en">
<head>
    <title>Settings - pH Dosing System</title>
</head>
<body>
    <h1>Settings</h1>

    <h2>Assign USB Devices</h2>
    <form id="usb-form">
        <label for="ph-device">pH Probe:</label>
        <select id="ph-device" name="ph-device"></select><br><br>

        <label for="relay-device">Relay Module:</label>
        <select id="relay-device" name="relay-device"></select><br><br>

        <button type="submit">Save</button>
    </form>

    <button id="rescan-usb">Rescan USB Devices</button>
    <div id="status"></div>

    <script>
        // Fetch the list of USB devices
        const fetchUsbDevices = () => {
            fetch('/api/settings/usb_devices')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch USB devices');
                    }
                    return response.json();
                })
                .then(devices => {
                    const phDeviceDropdown = document.getElementById('ph-device');
                    const relayDeviceDropdown = document.getElementById('relay-device');

                    // Create Sets to track current dropdown options
                    const currentPhOptions = new Set([...phDeviceDropdown.options].map(option => option.value));
                    const currentRelayOptions = new Set([...relayDeviceDropdown.options].map(option => option.value));

                    devices.forEach(device => {
                        // Add to pH Probe dropdown if not already present
                        if (!currentPhOptions.has(device.device)) {
                            const option = document.createElement('option');
                            option.value = device.device;
                            option.textContent = device.device;
                            phDeviceDropdown.appendChild(option);
                        }

                        // Add to Relay Module dropdown if not already present
                        if (!currentRelayOptions.has(device.device)) {
                            const option = document.createElement('option');
                            option.value = device.device;
                            option.textContent = device.device;
                            relayDeviceDropdown.appendChild(option);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching USB devices:', error);
                    const statusDiv = document.getElementById('status');
                    statusDiv.textContent = 'Error fetching USB devices. Please try again.';
                });
        };

        // Fetch USB devices on page load
        fetchUsbDevices();

        // Rescan USB devices when the button is clicked
        document.getElementById('rescan-usb').addEventListener('click', (event) => {
            event.preventDefault();
            fetchUsbDevices();
        });

        // Handle form submission to save USB assignments
        document.getElementById('usb-form').addEventListener('submit', (event) => {
            event.preventDefault();

            const phDevice = document.getElementById('ph-device').value;
            const relayDevice = document.getElementById('relay-device').value;

            fetch('/api/settings/assign_usb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'ph_probe', device: phDevice })
            })
            .then(() => fetch('/api/settings/assign_usb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'relay', device: relayDevice })
            }))
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status');
                if (data.status === 'success') {
                    statusDiv.textContent = 'USB devices succe
