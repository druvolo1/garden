<!-- File: templates/settings.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>
    <!-- Navigation Menu -->
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/calibration">Calibration</a></li>
            <li><a href="/settings">Settings</a></li>
        </ul>
    </nav>

    <h1>Settings</h1>

    <h2>Assign USB Devices</h2>
    <form id="ph-form">
        <label for="ph-device">pH Probe:</label>
        <select id="ph-device" name="ph-device">
            <option value="">Select a device</option>
        </select>
        <button type="submit">Save pH Probe</button>
    </form>
    <br>

    <form id="relay-form">
        <label for="relay-device">Relay Module:</label>
        <select id="relay-device" name="relay-device">
            <option value="">Select a device</option>
        </select>
        <button type="submit">Save Relay Module</button>
    </form>
    <button id="rescan-usb">Rescan USB Devices</button>
    <div id="status"></div>

    <div id="relay-warning" style="color: red; display: none;">
        <strong>Relay module not assigned. Dosing-related settings are disabled.</strong>
    </div>

    <h2>pH Min/Max Range</h2>
    <form id="ph-range-form">
        <label for="ph-min">pH Range - Min:</label>
        <input type="number" id="ph-min" name="ph-min" step="0.01"><br><br>

        <label for="ph-max">pH Range - Max:</label>
        <input type="number" id="ph-max" name="ph-max" step="0.01"><br><br>

        <button type="submit">Save pH Range</button>
    </form>

    <h2>General Settings</h2>
    <form id="general-settings-form">
        <label for="ph-target">pH Target:</label>
        <input type="number" id="ph-target" name="ph-target" step="0.01" value="5.8" disabled><br><br>
    
        <label for="max-dosing">
            Max Dosing Amount (ml)
            <small>(Set to 0 for no maximum)</small>:
        </label>
        <input type="number" id="max-dosing" name="max-dosing" step="1" disabled><br><br>
    
        <label for="dosing-interval">Dosing Interval (hours):</label>
        <input type="number" id="dosing-interval" name="dosing-interval" step="1" disabled><br><br>
    
        <label for="system-volume">System Volume (gallons):</label>
        <input type="number" id="system-volume" name="system-volume" step=".1" disabled><br><br>
    
        <label for="time-zone">Time Zone:</label>
        <input type="text" id="time-zone" name="time-zone" disabled><br><br>
    
        <label for="auto-dosing">Auto-Dosing Enabled:</label>
        <input type="checkbox" id="auto-dosing" name="auto-dosing" disabled><br><br>
    
        <button type="submit" id="general-save-btn" disabled>Save General Settings</button>
    </form>

    <h2>Dosage Strength</h2>
    <form id="dosage-strength-form">
        <label for="ph-up-strength">pH Up Dosage Strength (ml per pH point):</label>
        <input type="number" id="ph-up-strength" name="ph-up-strength" step="0.01" disabled><br><br>

        <label for="ph-down-strength">pH Down Dosage Strength (ml per pH point):</label>
        <input type="number" id="ph-down-strength" name="ph-down-strength" step="0.01" disabled><br><br>

        <button type="submit" id="dosage-save-btn" disabled>Save Dosage Strength</button>
    </form>

    <h2>Pump Calibration</h2>
    <form id="pump-calibration-form">
        <label for="pump1-calibration">pH Up Pump Calibration (seconds per ml):</label>
        <input type="number" id="pump1-calibration" name="pump1-calibration" step="0.01" disabled><br><br>

        <label for="pump2-calibration">pH Down Pump Calibration (seconds per ml):</label>
        <input type="number" id="pump2-calibration" name="pump2-calibration" step="0.01" disabled><br><br>

        <button type="submit" id="pump-calibration-save-btn" disabled>Save Pump Calibration</button>
    </form>

    <!-- New Section for Relay Port Assignments -->
    <h2>Relay Port Assignments</h2>
    <form id="relay-port-form">
        <label for="ph-up-relay-port">pH Up Relay Port:</label>
        <select id="ph-up-relay-port" name="ph-up-relay-port" disabled>
            <!-- For a 2-port relay, just 1 & 2. Add more if needed -->
            <option value="1">Relay 1</option>
            <option value="2">Relay 2</option>
        </select>
        <br><br>

        <label for="ph-down-relay-port">pH Down Relay Port:</label>
        <select id="ph-down-relay-port" name="ph-down-relay-port" disabled>
            <option value="1">Relay 1</option>
            <option value="2">Relay 2</option>
        </select>
        <br><br>

        <button type="submit" id="relay-port-save-btn" disabled>Save Relay Port Assignments</button>
    </form>

    <script>
        const piIp = "{{ pi_ip }}"; // Rendered by Flask
        console.log("Connecting to Pi IP:", piIp);

        const fetchUsbDevices = () => {
            console.log('Rescanning USB devices...');
            Promise.all([
                fetch(`http://${piIp}:5000/api/settings/usb_devices`).then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch USB devices');
                    }
                    return response.json();
                }),
                fetch(`http://${piIp}:5000/api/settings`).then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch settings');
                    }
                    return response.json();
                })
            ])
            .then(([devices, settings]) => {
                console.log('Devices to add:', devices);
                console.log('Current settings:', settings);

                const phDeviceDropdown = document.getElementById('ph-device');
                const relayDeviceDropdown = document.getElementById('relay-device');
                const assignedPhProbe = settings.usb_roles?.ph_probe || "";
                const assignedRelay = settings.usb_roles?.relay || "";

                // Clear dropdowns
                phDeviceDropdown.innerHTML = '<option value="">Select a device</option>';
                relayDeviceDropdown.innerHTML = '<option value="">Select a device</option>';

                // Populate dropdowns
                devices.forEach(device => {
                    const phOption = document.createElement('option');
                    phOption.value = device.device;
                    phOption.textContent = device.device;
                    if (device.device === assignedPhProbe) phOption.selected = true;
                    phDeviceDropdown.appendChild(phOption);

                    const relayOption = document.createElement('option');
                    relayOption.value = device.device;
                    relayOption.textContent = device.device;
                    if (device.device === assignedRelay) relayOption.selected = true;
                    relayDeviceDropdown.appendChild(relayOption);
                });

                // Populate existing settings
                document.getElementById('ph-min').value = settings.ph_range?.min || '';
                document.getElementById('ph-max').value = settings.ph_range?.max || '';
                document.getElementById('ph-target').value = settings.ph_target || '5.8';
                document.getElementById('max-dosing').value = settings.max_dosing_amount || '0';
                document.getElementById('dosing-interval').value = settings.dosing_interval || '';
                document.getElementById('system-volume').value = settings.system_volume || '';
                document.getElementById('time-zone').value = settings.time_zone || '';
                document.getElementById('auto-dosing').checked = !!settings.auto_dosing_enabled;
                document.getElementById('ph-up-strength').value = settings.dosage_strength?.ph_up || '';
                document.getElementById('ph-down-strength').value = settings.dosage_strength?.ph_down || '';
                document.getElementById('pump1-calibration').value = settings.pump_calibration?.pump1 || '';
                document.getElementById('pump2-calibration').value = settings.pump_calibration?.pump2 || '';

                // Relay port assignments (defaults, if missing)
                const relayPorts = settings.relay_ports || { ph_up: 1, ph_down: 2 };
                document.getElementById('ph-up-relay-port').value = relayPorts.ph_up;
                document.getElementById('ph-down-relay-port').value = relayPorts.ph_down;

                // Enable/Disable settings based on relay assignment
                const isRelayAssigned = Boolean(assignedRelay);
                document.querySelectorAll('#general-settings-form input, #dosage-strength-form input, #pump-calibration-form input, #general-save-btn, #dosage-save-btn, #pump-calibration-save-btn, #relay-port-form select, #relay-port-save-btn').forEach(el => {
                    el.disabled = !isRelayAssigned;
                });

                // Show relay warning if no relay is assigned
                const relayWarning = document.getElementById('relay-warning');
                relayWarning.style.display = isRelayAssigned ? 'none' : 'block';
            })
            .catch(error => console.error('Error fetching USB devices or settings:', error));
        };

        const saveUsbAssignment = (role, device) => {
            fetch(`http://${piIp}:5000/api/settings/assign_usb`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role, device })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(`${role} assigned successfully.`);
                    document.getElementById('status').textContent = `${role} assigned successfully.`;
                } else {
                    console.error(`Failed to assign ${role}:`, data.error);
                    document.getElementById('status').textContent = `Failed to assign ${role}.`;
                }
            })
            .catch(error => console.error(`Error saving ${role} assignment:`, error));
        };

        const saveSettings = (endpoint, payload) => {
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                console.log('Settings saved successfully');
                // Optionally re-fetch to refresh the UI if needed
                fetchUsbDevices();
            })
            .catch(error => console.error('Error saving settings:', error));
        };

        // -------------
        // Event Listeners
        // -------------

        // Save pH Probe assignment
        document.getElementById('ph-form').addEventListener('submit', event => {
            event.preventDefault();
            const phDevice = document.getElementById('ph-device').value;
            saveUsbAssignment('ph_probe', phDevice);
        });

        // Save Relay Module assignment
        document.getElementById('relay-form').addEventListener('submit', event => {
            event.preventDefault();
            const relayDevice = document.getElementById('relay-device').value;
            saveUsbAssignment('relay', relayDevice);
        });

        // Save General Settings
        document.getElementById('general-settings-form').addEventListener('submit', event => {
            event.preventDefault();
            saveSettings(`http://${piIp}:5000/api/settings`, {
                ph_target: parseFloat(document.getElementById('ph-target').value),
                max_dosing_amount: parseFloat(document.getElementById('max-dosing').value),
                dosing_interval: parseFloat(document.getElementById('dosing-interval').value),
                system_volume: parseFloat(document.getElementById('system-volume').value),
                time_zone: document.getElementById('time-zone').value,
                auto_dosing_enabled: document.getElementById('auto-dosing').checked
            });
        });

        // Save Dosage Strength
        document.getElementById('dosage-strength-form').addEventListener('submit', event => {
            event.preventDefault();
            const phUp = parseFloat(document.getElementById('ph-up-strength').value);
            const phDown = parseFloat(document.getElementById('ph-down-strength').value);

            const payload = {
                dosage_strength: {
                    ph_up: phUp,
                    ph_down: phDown
                }
            };
            saveSettings(`http://${piIp}:5000/api/settings`, payload);
        });

        // Save Pump Calibration
        document.getElementById('pump-calibration-form').addEventListener('submit', event => {
            event.preventDefault();
            saveSettings(`http://${piIp}:5000/api/settings`, {
                pump_calibration: {
                    pump1: parseFloat(document.getElementById('pump1-calibration').value),
                    pump2: parseFloat(document.getElementById('pump2-calibration').value)
                }
            });
        });

        // Save Relay Port Assignments
        document.getElementById('relay-port-form').addEventListener('submit', event => {
            event.preventDefault();
            const phUpPort = parseInt(document.getElementById('ph-up-relay-port').value, 10);
            const phDownPort = parseInt(document.getElementById('ph-down-relay-port').value, 10);

            const payload = {
                relay_ports: {
                    ph_up: phUpPort,
                    ph_down: phDownPort
                }
            };
            saveSettings(`http://${piIp}:5000/api/settings`, payload);
        });

        // Fetch devices & settings on page load
        fetchUsbDevices();
    </script>
</body>
</html>
