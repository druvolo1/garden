<!DOCTYPE html>
<html lang="en">
<head>
    <title>Settings - pH Dosing System</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
    <h1>Settings</h1>

    <h2>Assign USB Devices</h2>

    <form id="ph-form">
        <label for="ph-device">pH Probe:</label>
        <select id="ph-device" name="ph-device">
            <option value="">Select a device</option>
        </select>
        <button type="submit">Save pH Probe</button>
    </form>
    <br>

    <form id="relay-form">
        <label for="relay-device">Relay Module:</label>
        <select id="relay-device" name="relay-device">
            <option value="">Select a device</option>
        </select>
        <button type="submit">Save Relay Module</button>
    </form>

    <button id="rescan-usb">Rescan USB Devices</button>
    <div id="status"></div>

    <script>
        // Dynamically get the Pi's IP address passed from the backend
        const piIp = "{{ pi_ip }}"; // Rendered by Flask
        console.log("Connecting to Pi IP:", piIp);

        // Fetch the list of USB devices and previously saved settings
        const fetchUsbDevices = () => {
            console.log('Rescanning USB devices...');

            // Fetch USB devices and settings in parallel
            Promise.all([
                fetch(`http://${piIp}:5000/api/settings/usb_devices`).then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch USB devices');
                    }
                    return response.json();
                }),
                fetch(`http://${piIp}:5000/api/settings`).then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch settings');
                    }
                    return response.json();
                })
            ])
            .then(([devices, settings]) => {
                console.log('Devices to add:', devices);
                console.log('Current settings:', settings);

                const phDeviceDropdown = document.getElementById('ph-device');
                const relayDeviceDropdown = document.getElementById('relay-device');

                // Get saved device assignments
                const assignedPhProbe = settings.usb_roles?.ph_probe || "";
                const assignedRelay = settings.usb_roles?.relay || "";

                // Clear existing dropdown options
                phDeviceDropdown.innerHTML = '<option value="">Select a device</option>';
                relayDeviceDropdown.innerHTML = '<option value="">Select a device</option>';

                devices.forEach(device => {
                    console.log('Processing device:', device.device);

                    // Add to pH Probe dropdown
                    const phOption = document.createElement('option');
                    phOption.value = device.device;
                    phOption.textContent = device.device;
                    if (device.device === assignedPhProbe) {
                        phOption.selected = true; // Preselect saved value
                    }
                    phDeviceDropdown.appendChild(phOption);

                    // Add to Relay Module dropdown
                    const relayOption = document.createElement('option');
                    relayOption.value = device.device;
                    relayOption.textContent = device.device;
                    if (device.device === assignedRelay) {
                        relayOption.selected = true; // Preselect saved value
                    }
                    relayDeviceDropdown.appendChild(relayOption);
                });
            })
            .catch(error => {
                console.error('Error fetching USB devices or settings:', error);
                const statusDiv = document.getElementById('status');
                statusDiv.textContent = 'Error loading settings. Please try again.';
            });
        };

        // Fetch USB devices and settings on page load
        fetchUsbDevices();

        // Rescan USB devices when the button is clicked
        document.getElementById('rescan-usb').addEventListener('click', (event) => {
            event.preventDefault();
            console.log('Rescan button clicked');
            fetchUsbDevices();
        });

        // Handle pH Probe assignment
        document.getElementById('ph-form').addEventListener('submit', (event) => {
            event.preventDefault();

            const phDevice = document.getElementById('ph-device').value;

            fetch(`http://${piIp}:5000/api/settings/assign_usb`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'ph_probe', device: phDevice })
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status');
                if (data.status === 'success') {
                    statusDiv.textContent = 'pH Probe assigned successfully!';
                } else {
                    statusDiv.textContent = `Failed to assign pH Probe: ${data.error}`;
                }
            });
        });

        // Handle Relay Module assignment
        document.getElementById('relay-form').addEventListener('submit', (event) => {
            event.preventDefault();

            const relayDevice = document.getElementById('relay-device').value;

            fetch(`http://${piIp}:5000/api/settings/assign_usb`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'relay', device: relayDevice })
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status');
                if (data.status === 'success') {
                    statusDiv.textContent = 'Relay Module assigned successfully!';
                } else {
                    statusDiv.textContent = `Failed to assign Relay Module: ${data.error}`;
                }
            });
        });
    </script>
</body>
</html>
