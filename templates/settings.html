<!DOCTYPE html>
<html lang="en">
<head>
    <title>Settings - pH Dosing System</title>
</head>
<body>
    <h1>Settings</h1>

    <h2>Assign USB Devices</h2>

    <form id="ph-form">
        <label for="ph-device">pH Probe:</label>
        <select id="ph-device" name="ph-device">
            <option value="">Select a device</option>
        </select>
        <button type="submit">Save pH Probe</button>
    </form>
    <br>

    <form id="relay-form">
        <label for="relay-device">Relay Module:</label>
        <select id="relay-device" name="relay-device">
            <option value="">Select a device</option>
        </select>
        <button type="submit">Save Relay Module</button>
    </form>

    <button id="rescan-usb">Rescan USB Devices</button>
    <div id="status"></div>

    <script>
        // Fetch the list of USB devices
        const fetchUsbDevices = () => {
            console.log('Rescanning USB devices...');

            fetch('/api/settings/usb_devices')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch USB devices');
                    }
                    return response.json();
                })
                .then(devices => {
                    console.log('Populating dropdowns...');
                    console.log('Devices to add:', devices);

                    const phDeviceDropdown = document.getElementById('ph-device');
                    const relayDeviceDropdown = document.getElementById('relay-device');

                    // Save current selections
                    const selectedPhDevice = phDeviceDropdown.value;
                    const selectedRelayDevice = relayDeviceDropdown.value;

                    // Clear existing dropdown options
                    phDeviceDropdown.innerHTML = '<option value="">Select a device</option>';
                    relayDeviceDropdown.innerHTML = '<option value="">Select a device</option>';

                    devices.forEach(device => {
                        console.log('Processing device:', device.device);

                        // Add to pH Probe dropdown
                        const phOption = document.createElement('option');
                        phOption.value = device.device;
                        phOption.textContent = device.device;
                        if (device.device === selectedPhDevice) {
                            phOption.selected = true; // Preserve selection if still connected
                        }
                        phDeviceDropdown.appendChild(phOption);

                        // Add to Relay Module dropdown
                        const relayOption = document.createElement('option');
                        relayOption.value = device.device;
                        relayOption.textContent = device.device;
                        if (device.device === selectedRelayDevice) {
                            relayOption.selected = true; // Preserve selection if still connected
                        }
                        relayDeviceDropdown.appendChild(relayOption);
                    });
                })
                .catch(error => {
                    console.error('Error fetching USB devices:', error);
                    const statusDiv = document.getElementById('status');
                    statusDiv.textContent = 'Error fetching USB devices. Please try again.';
                });
        };

        // Fetch USB devices on page load
        fetchUsbDevices();

        // Rescan USB devices when the button is clicked
        document.getElementById('rescan-usb').addEventListener('click', (event) => {
            event.preventDefault();
            console.log('Rescan button clicked');
            fetchUsbDevices();
        });

        // Handle pH Probe assignment
        document.getElementById('ph-form').addEventListener('submit', (event) => {
            event.preventDefault();

            const phDevice = document.getElementById('ph-device').value;

            fetch('/api/settings/assign_usb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'ph_probe', device: phDevice })
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status');
                if (data.status === 'success') {
                    statusDiv.textContent = 'pH Probe assigned successfully!';
                } else {
                    statusDiv.textContent = `Failed to assign pH Probe: ${data.error}`;
                }
            });
        });

        // Handle Relay Module assignment
        document.getElementById('relay-form').addEventListener('submit', (event) => {
            event.preventDefault();

            const relayDevice = document.getElementById('relay-device').value;

            fetch('/api/settings/assign_usb', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role: 'relay', device: relayDevice })
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status');
                if (data.status === 'success') {
                    statusDiv.textContent = 'Relay Module assigned successfully!';
                } else {
                    statusDiv.textContent = `Failed to assign Relay Module: ${data.error}`;
                }
            });
        });
    </script>
</body>
</html>
