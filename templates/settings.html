<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>

    <!-- Navigation Menu -->
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/calibration">Calibration</a></li>
            <li><a href="/configuration">Configuration</a></li>
            <li><a href="/dosage">Dosage</a></li>
            <li><a href="/settings">Settings</a></li>
            <li><a href="/valves">Valves</a></li>
        </ul>
    </nav>

    <main>
        <h1>Settings</h1>
        <p class="subtitle">Configure your device, dosing, and sensors.</p>

        <div class="settings-grid">

            <!-- USB Device Assignment -->
            <div class="data-container">
                <h2>Assign USB Devices</h2>

                <!-- pH Probe Form -->
                <form id="ph-form">
                    <label for="ph-device">pH Probe:</label>
                    <select id="ph-device" name="ph-device">
                        <option value="">Select a device</option>
                    </select>
                    <button type="submit">Save pH Probe</button>
                </form>

                <!-- Dosing Relay Module Form -->
                <form id="dosing-relay-form">
                    <label for="dosing-relay-device">Dosing Relay Module:</label>
                    <select id="dosing-relay-device" name="dosing-relay-device">
                        <option value="">Select a device</option>
                    </select>
                    <button type="submit">Save Dosing Relay Module</button>
                </form>

                <!-- Valve Relay Module Form -->
                <form id="valve-relay-form">
                    <label for="valve-relay-device">Valve Relay Module:</label>
                    <select id="valve-relay-device" name="valve-relay-device">
                        <option value="">Select a device</option>
                    </select>
                    <button type="submit">Save Valve Relay Module</button>
                </form>

                <button id="rescan-usb" onclick="fetchUsbDevices()">Rescan USB Devices</button>
                <div id="status"></div>

                <div id="relay-warning" class="error-message" style="display: none;">
                    <strong>Dosing Relay module not assigned. Dosing-related settings are disabled.</strong>
                </div>
            </div>

            <!-- pH Min/Max Range -->
            <div class="data-container">
                <h2>pH Min/Max Range</h2>
                <form id="ph-range-form">
                    <label for="ph-min">pH Range - Min:</label>
                    <input type="number" id="ph-min" name="ph-min" step="0.01">

                    <label for="ph-max">pH Range - Max:</label>
                    <input type="number" id="ph-max" name="ph-max" step="0.01">

                    <button type="submit">Save pH Range</button>
                </form>
            </div>

            <!-- General Settings -->
            <div class="data-container">
                <h2>General Settings</h2>
                <form id="general-settings-form">

                    <label for="system-name">System Name:</label>
                    <input type="text" id="system-name" name="system-name">

                    <label for="ph-target">pH Target:</label>
                    <input type="number" id="ph-target" name="ph-target" step="0.01" disabled>

                    <label for="max-dosing">Max Dosing Amount (ml):</label>
                    <input type="number" id="max-dosing" name="max-dosing" step="1" disabled>

                    <label for="dosing-interval">Dosing Interval (hours):</label>
                    <input type="number" id="dosing-interval" name="dosing-interval" step=".0001" disabled>

                    <label for="system-volume">System Volume (gallons):</label>
                    <input type="number" id="system-volume" name="system-volume" step=".1" disabled>

                    <label for="time-zone">Time Zone:</label>
                    <input type="text" id="time-zone" name="time-zone" disabled>

                    <label for="auto-dosing">Auto-Dosing Enabled:</label>
                    <input type="checkbox" id="auto-dosing" name="auto-dosing" disabled>

                    <button type="submit" id="general-save-btn" disabled>Save General Settings</button>
                </form>
            </div>

            <!-- Dosage Strength -->
            <div class="data-container">
                <h2>Dosage Strength</h2>
                <form id="dosage-strength-form">
                    <label for="ph-up-strength">pH Up Dosage Strength (ml per pH point):</label>
                    <input type="number" id="ph-up-strength" name="ph-up-strength" step="0.01" disabled>

                    <label for="ph-down-strength">pH Down Dosage Strength (ml per pH point):</label>
                    <input type="number" id="ph-down-strength" name="ph-down-strength" step="0.01" disabled>

                    <button type="submit" id="dosage-save-btn" disabled>Save Dosage Strength</button>
                </form>
            </div>

            <!-- Pump Calibration -->
            <div class="data-container">
                <h2>Pump Calibration</h2>
                <form id="pump-calibration-form">
                    <label for="pump1-calibration">pH Up Pump Calibration (seconds per ml):</label>
                    <input type="number" id="pump1-calibration" name="pump1-calibration" step="0.01" disabled><br><br>

                    <label for="pump2-calibration">pH Down Pump Calibration (seconds per ml):</label>
                    <input type="number" id="pump2-calibration" name="pump2-calibration" step="0.01" disabled><br><br>

                    <button type="submit" id="pump-calibration-save-btn" disabled>Save Pump Calibration</button>
                </form>
            </div>

            <!-- Relay Port Assignments (for Dosing) -->
            <div class="data-container">
                <h2>Dosing Relay Port Assignments</h2>
                <form id="relay-port-form">
                    <label for="ph-up-relay-port">pH Up Relay Port:</label>
                    <select id="ph-up-relay-port" name="ph-up-relay-port" disabled>
                        <option value="1">Relay 1</option>
                        <option value="2">Relay 2</option>
                    </select>
                    <br><br>

                    <label for="ph-down-relay-port">pH Down Relay Port:</label>
                    <select id="ph-down-relay-port" name="ph-down-relay-port" disabled>
                        <option value="1">Relay 1</option>
                        <option value="2">Relay 2</option>
                    </select>
                    <br><br>

                    <button type="submit" id="relay-port-save-btn" disabled>Save Relay Port Assignments</button>
                </form>
            </div>

            <!-- Plant Info Section -->
            <div class="data-container">
                <h2>Plant Info</h2>
                <form id="plant-info-form">
                    <label for="plant-name">Plant Name:</label>
                    <input type="text" id="plant-name" name="plant-name"><br><br>

                    <label for="plant-start-date">Plant Start Date:</label>
                    <input type="date" id="plant-start-date" name="plant-start-date"><br><br>

                    <label>Weeks Since Start:</label>
                    <span id="weeks-since-start">0</span><br><br>

                    <button type="submit">Save Plant Info</button>
                </form>
            </div>

            <!-- Water Level Sensors -->
            <div class="data-container">
                <h2>Water Level Sensors</h2>
                <form id="water-level-sensors-form">
                    <fieldset>
                        <legend>Sensor 1</legend>
                        <label>Label:</label>
                        <input type="text" id="sensor1-label">
                        <label>Pin:</label>
                        <input type="number" id="sensor1-pin">
                    </fieldset>

                    <fieldset>
                        <legend>Sensor 2</legend>
                        <label>Label:</label>
                        <input type="text" id="sensor2-label">
                        <label>Pin:</label>
                        <input type="number" id="sensor2-pin">
                    </fieldset>

                    <fieldset>
                        <legend>Sensor 3</legend>
                        <label>Label:</label>
                        <input type="text" id="sensor3-label">
                        <label>Pin:</label>
                        <input type="number" id="sensor3-pin">
                    </fieldset>

                    <button type="submit">Save Water Sensors</button>
                </form>
            </div>

        </div>
    </main>

    <script>
        // On DOM load, fetch devices and settings
        document.addEventListener('DOMContentLoaded', () => {
            fetchUsbDevices();
        });
        
        // Function to update weeks since start
        function updateWeeksSinceStart(startDateStr) {
            const weeksSpan = document.getElementById('weeks-since-start');
            if (!startDateStr) {
                weeksSpan.textContent = '0';
                return;
            }
            const startDate = new Date(startDateStr);
            if (isNaN(startDate)) {
                weeksSpan.textContent = '0';
                return;
            }
            const now = new Date();
            const diffMs = now - startDate;
            if (diffMs < 0) {
                weeksSpan.textContent = '0';
                return;
            }
            const weeks = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 7));
            weeksSpan.textContent = weeks.toString();
        }

        // Fetch devices + settings
        function fetchUsbDevices() {
            console.log('Rescanning USB devices...');
            Promise.all([
                fetch("/api/settings/usb_devices").then(response => response.json()),
                fetch("/api/settings").then(response => response.json())
            ])
            .then(([devices, settings]) => {
                console.log('Devices:', devices);
                console.log('Settings:', settings);

                // Populate dropdowns
                const phDevSelect = document.getElementById('ph-device');
                const dosingDevSelect = document.getElementById('dosing-relay-device');
                const valveDevSelect = document.getElementById('valve-relay-device');

                const assignedPh = settings.usb_roles?.ph_probe || "";
                const assignedDosing = settings.usb_roles?.relay || "";
                const assignedValve = settings.usb_roles?.valve_relay || "";

                phDevSelect.innerHTML = '<option value="">Select a device</option>';
                dosingDevSelect.innerHTML = '<option value="">Select a device</option>';
                valveDevSelect.innerHTML = '<option value="">Select a device</option>';

                devices.forEach(dev => {
                    const phOption = document.createElement('option');
                    phOption.value = dev.device;
                    phOption.textContent = dev.device;
                    if (phOption.value === assignedPh) phOption.selected = true;
                    phDevSelect.appendChild(phOption);

                    const dosingOption = document.createElement('option');
                    dosingOption.value = dev.device;
                    dosingOption.textContent = dev.device;
                    if (dosingOption.value === assignedDosing) dosingOption.selected = true;
                    dosingDevSelect.appendChild(dosingOption);

                    const valveOption = document.createElement('option');
                    valveOption.value = dev.device;
                    valveOption.textContent = dev.device;
                    if (valveOption.value === assignedValve) valveOption.selected = true;
                    valveDevSelect.appendChild(valveOption);
                });

                // Example: enable or disable fields if dosing relay isn't assigned
                const isDosingRelayAssigned = Boolean(assignedDosing);
                document.querySelectorAll(
                    '#general-settings-form input, #dosage-strength-form input, #pump-calibration-form input, #general-save-btn, #dosage-save-btn, #pump-calibration-save-btn, #relay-port-form select, #relay-port-save-btn'
                ).forEach(el => {
                    // Keep system-name always enabled; the rest depends on the Dosing Relay
                    if (el.id !== 'system-name') {
                        el.disabled = !isDosingRelayAssigned;
                    }
                });

                // Show warning if no relay
                const relayWarning = document.getElementById('relay-warning');
                relayWarning.style.display = isDosingRelayAssigned ? 'none' : 'block';

                // pH Range
                document.getElementById('ph-min').value = settings.ph_range?.min || '';
                document.getElementById('ph-max').value = settings.ph_range?.max || '';

                // General
                document.getElementById('system-name').value = settings.system_name || '';
                document.getElementById('ph-target').value = settings.ph_target || '5.8';
                document.getElementById('max-dosing').value = settings.max_dosing_amount || '0';
                document.getElementById('dosing-interval').value = settings.dosing_interval || '1';
                document.getElementById('system-volume').value = settings.system_volume || '';
                document.getElementById('time-zone').value = settings.time_zone || '';
                document.getElementById('auto-dosing').checked = !!settings.auto_dosing_enabled;

                // Dosage Strength
                document.getElementById('ph-up-strength').value = settings.dosage_strength?.ph_up || '';
                document.getElementById('ph-down-strength').value = settings.dosage_strength?.ph_down || '';

                // Pump Calibration
                document.getElementById('pump1-calibration').value = settings.pump_calibration?.pump1 || '';
                document.getElementById('pump2-calibration').value = settings.pump_calibration?.pump2 || '';

                // Relay Ports
                const relayPorts = settings.relay_ports || { ph_up: 1, ph_down: 2 };
                document.getElementById('ph-up-relay-port').value = relayPorts.ph_up;
                document.getElementById('ph-down-relay-port').value = relayPorts.ph_down;

                // PLANT INFO:
                const plantInfo = settings.plant_info || {};
                document.getElementById('plant-name').value = plantInfo.name || '';
                document.getElementById('plant-start-date').value = plantInfo.start_date || '';
                updateWeeksSinceStart(plantInfo.start_date);

                // WATER LEVEL SENSORS
                const sensors = settings.water_level_sensors || {
                    sensor1: { label: "Full", pin: 22 },
                    sensor2: { label: "3 Gal", pin: 23 },
                    sensor3: { label: "Empty", pin: 24 }
                };

                console.log('Water Level Sensors:', sensors); // Debugging line

                // Populate each sensor field
                document.getElementById('sensor1-label').value = sensors.sensor1.label;
                document.getElementById('sensor1-pin').value = sensors.sensor1.pin;
                document.getElementById('sensor2-label').value = sensors.sensor2.label;
                document.getElementById('sensor2-pin').value = sensors.sensor2.pin;
                document.getElementById('sensor3-label').value = sensors.sensor3.label;
                document.getElementById('sensor3-pin').value = sensors.sensor3.pin;
            })
            .catch(error => console.error('Error scanning devices or fetching settings:', error));
        }

        // Helper to POST usb assignment to the server
        function saveUsbAssignment(role, device) {
            fetch("/api/settings/assign_usb", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role, device })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('status').textContent = `${role} assigned successfully.`;
                } else {
                    document.getElementById('status').textContent = `Failed to assign ${role}: ${data.error}`;
                }
                // Re-fetch devices + settings to update UI
                fetchUsbDevices();
            })
            .catch(err => console.error(`Error assigning ${role}:`, err));
        }

        // Helper to POST settings to the server
        function saveSettings(endpoint, payload) {
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                console.log('Settings saved successfully');
                // Optionally re-fetch to refresh UI
                fetchUsbDevices();
            })
            .catch(error => console.error('Error saving settings:', error));
        }

        // pH Probe
        document.getElementById('ph-form').addEventListener('submit', evt => {
            evt.preventDefault();
            const dev = document.getElementById('ph-device').value;
            saveUsbAssignment('ph_probe', dev);
        });

        // Dosing Relay
        document.getElementById('dosing-relay-form').addEventListener('submit', evt => {
            evt.preventDefault();
            const dev = document.getElementById('dosing-relay-device').value;
            saveUsbAssignment('relay', dev);
        });

        // Valve Relay
        document.getElementById('valve-relay-form').addEventListener('submit', evt => {
            evt.preventDefault();
            const dev = document.getElementById('valve-relay-device').value;
            saveUsbAssignment('valve_relay', dev);
        });

        // pH Range
        document.getElementById('ph-range-form').addEventListener('submit', event => {
            event.preventDefault();
            const minVal = parseFloat(document.getElementById('ph-min').value);
            const maxVal = parseFloat(document.getElementById('ph-max').value);
            const payload = {
                ph_range: {
                    min: minVal,
                    max: maxVal
                }
            };
            saveSettings("/api/settings", payload);
        });

        // General
        document.getElementById('general-settings-form').addEventListener('submit', event => {
            event.preventDefault();
            const payload = {
                system_name: document.getElementById('system-name').value,
                ph_target: parseFloat(document.getElementById('ph-target').value),
                max_dosing_amount: parseFloat(document.getElementById('max-dosing').value),
                dosing_interval: parseFloat(document.getElementById('dosing-interval').value),
                system_volume: parseFloat(document.getElementById('system-volume').value),
                time_zone: document.getElementById('time-zone').value,
                auto_dosing_enabled: document.getElementById('auto-dosing').checked
            };
            saveSettings("/api/settings", payload);
        });

        // Dosage Strength
        document.getElementById('dosage-strength-form').addEventListener('submit', event => {
            event.preventDefault();
            const phUp = parseFloat(document.getElementById('ph-up-strength').value);
            const phDown = parseFloat(document.getElementById('ph-down-strength').value);
            const payload = {
                dosage_strength: {
                    ph_up: phUp,
                    ph_down: phDown
                }
            };
            saveSettings("/api/settings", payload);
        });

        // Pump Calibration
        document.getElementById('pump-calibration-form').addEventListener('submit', event => {
            event.preventDefault();
            const payload = {
                pump_calibration: {
                    pump1: parseFloat(document.getElementById('pump1-calibration').value),
                    pump2: parseFloat(document.getElementById('pump2-calibration').value)
                }
            };
            saveSettings("/api/settings", payload);
        });

        // Relay Ports
        document.getElementById('relay-port-form').addEventListener('submit', event => {
            event.preventDefault();
            const phUpPort = parseInt(document.getElementById('ph-up-relay-port').value, 10);
            const phDownPort = parseInt(document.getElementById('ph-down-relay-port').value, 10);
            const payload = {
                relay_ports: {
                    ph_up: phUpPort,
                    ph_down: phDownPort
                }
            };
            saveSettings("/api/settings", payload);
        });

        // Plant Info
        document.getElementById('plant-info-form').addEventListener('submit', event => {
            event.preventDefault();
            const plantName = document.getElementById('plant-name').value;
            const startDate = document.getElementById('plant-start-date').value;
            const payload = {
                plant_info: {
                    name: plantName,
                    start_date: startDate
                }
            };
            saveSettings("/api/settings", payload);
        });

        document.getElementById('plant-start-date').addEventListener('change', (e) => {
            updateWeeksSinceStart(e.target.value);
        });

        // Water Level Sensors
        document.getElementById('water-level-sensors-form').addEventListener('submit', event => {
            event.preventDefault();

            const sensor1Label = document.getElementById('sensor1-label').value;
            const sensor1Pin = parseInt(document.getElementById('sensor1-pin').value, 10) || 22;

            const sensor2Label = document.getElementById('sensor2-label').value;
            const sensor2Pin = parseInt(document.getElementById('sensor2-pin').value, 10) || 23;

            const sensor3Label = document.getElementById('sensor3-label').value;
            const sensor3Pin = parseInt(document.getElementById('sensor3-pin').value, 10) || 24;

            const payload = {
                water_level_sensors: {
                    sensor1: { label: sensor1Label, pin: sensor1Pin },
                    sensor2: { label: sensor2Label, pin: sensor2Pin },
                    sensor3: { label: sensor3Label, pin: sensor3Pin }
                }
            };
            saveSettings("/api/settings", payload);
        });
    </script>
</body>
</html>