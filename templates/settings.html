<!DOCTYPE html>
<html lang="en">
<head>
    <title>Settings - pH Dosing System</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
    <h1>Settings</h1>

    <h2>Assign USB Devices</h2>
    <form id="ph-form">
        <label for="ph-device">pH Probe:</label>
        <select id="ph-device" name="ph-device">
            <option value="">Select a device</option>
        </select>
        <button type="submit">Save pH Probe</button>
    </form>
    <br>

    <form id="relay-form">
        <label for="relay-device">Relay Module:</label>
        <select id="relay-device" name="relay-device">
            <option value="">Select a device</option>
        </select>
        <button type="submit">Save Relay Module</button>
    </form>
    <button id="rescan-usb">Rescan USB Devices</button>
    <div id="status"></div>

    <div id="relay-warning" style="color: red; display: none;">
        <strong>Relay module not assigned. Dosing-related settings are disabled.</strong>
    </div>

    <h2>pH Range for Notifications</h2>
    <form id="ph-range-form">
        <label for="ph-min">pH Range - Min:</label>
        <input type="number" id="ph-min" name="ph-min" step="0.01"><br><br>

        <label for="ph-max">pH Range - Max:</label>
        <input type="number" id="ph-max" name="ph-max" step="0.01"><br><br>

        <button type="submit">Save pH Range</button>
    </form>

    <h2>General Settings</h2>
    <form id="general-settings-form">
        <label for="max-dosing">Max Dosing Amount (ml):</label>
        <input type="number" id="max-dosing" name="max-dosing" step="1" disabled><br><br>

        <label for="dosing-interval">Dosing Interval (hours):</label>
        <input type="number" id="dosing-interval" name="dosing-interval" step="1" disabled><br><br>

        <label for="system-volume">System Volume (gallons):</label>
        <input type="number" id="system-volume" name="system-volume" step="1" disabled><br><br>

        <label for="time-zone">Time Zone:</label>
        <input type="text" id="time-zone" name="time-zone" disabled><br><br>

        <label for="auto-dosing">Auto-Dosing Enabled:</label>
        <input type="checkbox" id="auto-dosing" name="auto-dosing" disabled><br><br>

        <button type="submit" id="general-save-btn" disabled>Save General Settings</button>
    </form>

    <h2>Dosage Strength</h2>
    <form id="dosage-strength-form">
        <label for="ph-up-strength">pH Up Dosage Strength (ml per pH point):</label>
        <input type="number" id="ph-up-strength" name="ph-up-strength" step="0.01" disabled><br><br>

        <label for="ph-down-strength">pH Down Dosage Strength (ml per pH point):</label>
        <input type="number" id="ph-down-strength" name="ph-down-strength" step="0.01" disabled><br><br>

        <button type="submit" id="dosage-save-btn" disabled>Save Dosage Strength</button>
    </form>

    <h2>Pump Calibration</h2>
    <form id="pump-calibration-form">
        <label for="pump1-calibration">Pump 1 Calibration (seconds per ml):</label>
        <input type="number" id="pump1-calibration" name="pump1-calibration" step="0.01" disabled><br><br>

        <label for="pump2-calibration">Pump 2 Calibration (seconds per ml):</label>
        <input type="number" id="pump2-calibration" name="pump2-calibration" step="0.01" disabled><br><br>

        <button type="submit" id="pump-calibration-save-btn" disabled>Save Pump Calibration</button>
    </form>

    <script>
        const piIp = "{{ pi_ip }}"; // Rendered by Flask
        console.log("Connecting to Pi IP:", piIp);

        const fetchUsbDevices = () => {
            console.log('Rescanning USB devices...');
            Promise.all([
                fetch(`http://${piIp}:5000/api/settings/usb_devices`).then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch USB devices');
                    }
                    return response.json();
                }),
                fetch(`http://${piIp}:5000/api/settings`).then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch settings');
                    }
                    return response.json();
                })
            ])
            .then(([devices, settings]) => {
                console.log('Devices to add:', devices);
                console.log('Current settings:', settings);

                const phDeviceDropdown = document.getElementById('ph-device');
                const relayDeviceDropdown = document.getElementById('relay-device');
                const assignedRelay = settings.usb_roles?.relay || null;

                // Clear dropdowns and populate
                phDeviceDropdown.innerHTML = '<option value="">Select a device</option>';
                relayDeviceDropdown.innerHTML = '<option value="">Select a device</option>';
                devices.forEach(device => {
                    const phOption = document.createElement('option');
                    phOption.value = device.device;
                    phOption.textContent = device.device;
                    if (device.device === settings.usb_roles?.ph_probe) phOption.selected = true;
                    phDeviceDropdown.appendChild(phOption);

                    const relayOption = document.createElement('option');
                    relayOption.value = device.device;
                    relayOption.textContent = device.device;
                    if (device.device === assignedRelay) relayOption.selected = true;
                    relayDeviceDropdown.appendChild(relayOption);
                });

                // Populate general settings fields
                document.getElementById('max-dosing').value = settings.max_dosing_amount || '';
                document.getElementById('dosing-interval').value = settings.dosing_interval || '';
                document.getElementById('system-volume').value = settings.system_volume || '';
                document.getElementById('time-zone').value = settings.time_zone || '';
                document.getElementById('auto-dosing').checked = !!settings.auto_dosing_enabled;

                // Populate dosage strength fields
                document.getElementById('ph-up-strength').value = settings.dosage_strength?.ph_up || '';
                document.getElementById('ph-down-strength').value = settings.dosage_strength?.ph_down || '';

                // Enable/Disable fields and buttons based on relay assignment
                const isRelayAssigned = Boolean(assignedRelay);
                document.querySelectorAll('#general-settings-form input, #dosage-strength-form input, #pump-calibration-form input, #general-save-btn, #dosage-save-btn, #pump-calibration-save-btn').forEach(el => {
                    el.disabled = !isRelayAssigned;
                });

                // Show relay warning if no relay is assigned
                const relayWarning = document.getElementById('relay-warning');
                relayWarning.style.display = isRelayAssigned ? 'none' : 'block';
            })
            .catch(error => console.error('Error fetching USB devices or settings:', error));
        };

        // Save settings and fetch updates
        const saveSettings = (endpoint, payload) => {
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => fetchUsbDevices()) // Refresh settings after saving
            .catch(error => console.error('Error saving settings:', error));
        };

        document.getElementById('relay-form').addEventListener('submit', event => {
            event.preventDefault();
            const relayDevice = document.getElementById('relay-device').value || null;

            saveSettings(`http://${piIp}:5000/api/settings/assign_usb`, {
                role: 'relay',
                device: relayDevice
            });
        });

        fetchUsbDevices();
    </script>
</body>
</html>
