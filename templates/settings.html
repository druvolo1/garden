<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Settings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <style>
    /* Example styling for a disabled section */
    .disabled-section {
      opacity: 0.1; /* Visually dims the section */
      pointer-events: none; /* Prevents clicks, hovers, focus, etc. */
      position: relative;
    }
    .disabled-section::after {
      content: attr(data-disabled-title); /* Show custom tooltip text */
      display: none;
      background: #444;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      position: absolute;
      top: 5px;
      left: 5px;
      z-index: 9999;
    }
    .disabled-section:hover::after {
      display: block;
    }
    /* Optional: some minor styling for power-outlet cards */
    .power-outlet-card {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    .power-outlet-card h4 {
      margin: 0 0 10px 0;
    }
    .tracked-valve-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      gap: 10px;
    }
    .hidden {
      display: none;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #2a2a2a;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #f4c531;
      width: 80%;
      max-width: 400px;
      color: #f4c531;
    }
    .close {
      color: #f4c531;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: #fff;
      text-decoration: none;
      cursor: pointer;
    }
    .progress {
      width: 100%;
      background-color: #1e1e1e;
      margin: 20px 0;
    }
    .progress-bar {
      width: 0%;
      height: 30px;
      background-color: #f4c531;
      text-align: center;
      line-height: 30px;
      color: #2a2a2a;
    }
  </style>
</head>
<body>
  <!-- Navigation Menu -->
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/plant_info">Plant Info</a></li>
      <li><a href="/dosage">Dosage</a></li>
      <li><a href="/calibration">Calibration</a></li>
      <li><a href="/configuration">Configuration</a></li>
      <li><a href="/settings">Settings</a></li>
      <li><a href="/valves">Valves</a></li>
      <li><a href="/logs">Logs</a></li>
      <li><a href="/changelog">Changelog</a></li>
    </ul>
  </nav>
  <main>
    <h1>Settings</h1>
    <p class="subtitle">Configure your device, dosing, and sensors.</p>
    <div class="settings-grid">
      <!-- USB Device Assignment -->
      <div class="data-container">
        <h2>Assign USB Devices</h2>
  
        <!-- pH Probe Form -->
        <form id="ph-form">
          <label for="ph-device">pH Probe:</label>
          <select id="ph-device" name="ph-device">
            <option value="">Select a device</option>
          </select>
          <button type="submit">Save pH Probe</button>
        </form>
    
        <!-- Link that goes to Calibration - hidden by default and not blue -->
        <a id="ph-calibration-link"
           href="/calibration"
           style="display: none;
                  margin-bottom: 1em;
                  text-decoration: underline;
                  color: #ccc; /* or whatever color you like */
                  cursor: pointer;">
           Click here for Calibration
        </a>
  
        <!-- Dosing Relay Module Form -->
        <form id="dosing-relay-form">
          <label for="dosing-relay-device">Dosing Relay Module:</label>
          <select id="dosing-relay-device" name="dosing-relay-device">
            <option value="">Select a device</option>
          </select>
          <button type="submit">Save Dosing Relay Module</button>
        </form>
  
        <!-- Valve Relay Module Form (no mode dropdown, purely local USB path) -->
        <form id="valve-relay-form">
          <label for="valve-relay-device">Valve Relay Module:</label>
          <select id="valve-relay-device" name="valve-relay-device">
            <option value="">Select a device</option>
          </select>
          <button type="submit" id="valve-relay-save-btn">Save Valve Relay Setting</button>
        </form>
    
        <!-- Link that goes to Valves page - hidden by default and not blue -->
        <a id="valve-relay-link"
           href="/valves"
           style="display: none;
                  margin-top: 1em;
                  text-decoration: underline;
                  color: #ccc; /* or whatever color you like */
                  cursor: pointer;">
           Click here to Manage Valves
        </a>
  
        <!-- EC Meter Form -->
        <form id="ec-meter-form">
          <label for="ec-meter-device">EC Meter:</label>
          <select id="ec-meter-device" name="ec-meter-device">
            <option value="">Select a device</option>
          </select>
          <button type="submit">Save EC Meter</button>
        </form>
        <button id="rescan-usb" onclick="fetchUsbDevices()">Rescan USB Devices</button>
        <div id="status"></div>
        <div id="relay-warning" class="error-message" style="display: none;">
          <strong>Dosing Relay module not assigned. Dosing-related settings are disabled.</strong>
        </div>
      </div>
      <!-- pH Min/Max Range -->
      <div class="data-container" id="ph-range-container">
        <h2>pH Min/Max Range</h2>
        <form id="ph-range-form">
          <label for="ph-min">pH Range - Min:</label>
          <input type="number" id="ph-min" step="0.01">
          <label for="ph-max">pH Range - Max:</label>
          <input type="number" id="ph-max" step="0.01">
          <button type="submit">Save pH Range</button>
        </form>
      </div>
      <!-- General Settings (for Dosing) -->
      <div class="data-container" id="general-settings-container">
        <h2>General Settings</h2>
        <form id="general-settings-form">
          <label for="ph-target">pH Target:</label>
          <input type="number" id="ph-target" step="0.01">
          <label for="max-dosing">Max Dosing Amount (ml):</label>
          <input type="number" id="max-dosing" step="1">
          <label for="dosing-interval">Dosing Interval (hours):</label>
          <input type="number" id="dosing-interval" step=".0001">
          <button type="submit" id="general-save-btn">Save General Settings</button>
        </form>
      </div>
      <!-- Dosage Strength -->
      <div class="data-container" id="dosage-strength-container">
        <h2>Dosage Strength</h2>
        <form id="dosage-strength-form">
          <label for="ph-up-strength">pH Up Dosage Strength:</label>
          <input type="number" id="ph-up-strength" step="0.01">
          <label for="ph-down-strength">pH Down Dosage Strength:</label>
          <input type="number" id="ph-down-strength" step="0.01">
          <button type="submit">Save Dosage Strength</button>
        </form>
      </div>
      <!-- System Name -->
      <div class="data-container">
        <h2>System Name</h2>
        <form id="system-name-form">
          <label for="system-name">System Name:</label>
          <input type="text" id="system-name">
          <button type="submit">Save System Name</button>
        </form>
      </div>
      <!-- Time Zone -->
      <div class="data-container">
        <h2>Time Zone</h2>
        <form id="time-zone-form">
          <label for="time-zone">Time Zone:</label>
          <select id="time-zone"></select>
          <label for="daylight-savings">Daylight Savings Enabled:</label>
          <input type="checkbox" id="daylight-savings">
          <button type="submit">Save Time Zone</button>
        </form>
      </div>
      <!-- Pump Calibration -->
      <div class="data-container" id="pump-calibration-container">
        <h2>Pump Calibration</h2>
        <form id="pump-calibration-form">
          <label for="pump1-calibration">Pump 1 (pH Up) Calibration (ml/s):</label>
          <input type="number" id="pump1-calibration" step="0.01">
          <label for="pump2-calibration">Pump 2 (pH Down) Calibration (ml/s):</label>
          <input type="number" id="pump2-calibration" step="0.01">
          <button type="submit">Save Pump Calibration</button>
        </form>
        <div id="calibration-dates">
          <p>Pump 1 Last Calibrated: <span id="pump1-last-calibrated">N/A</span></p>
          <p>Pump 2 Last Calibrated: <span id="pump2-last-calibrated">N/A</span></p>
        </div>
      </div>
      <!-- Relay Ports -->
      <div class="data-container" id="relay-ports-container">
        <h2>Relay Ports</h2>
        <form id="relay-ports-form">
          <label for="ph-up-port">pH Up Port:</label>
          <input type="number" id="ph-up-port" min="1" max="8">
          <label for="ph-down-port">pH Down Port:</label>
          <input type="number" id="ph-down-port" min="1" max="8">
          <button type="submit">Save Relay Ports</button>
        </form>
      </div>
      <!-- Power Controls -->
      <div class="data-container" id="power-controls-container">
        <h2>Power Controls</h2>
        <div id="power-outlets-list"></div>
        <form id="add-outlet-form">
          <label for="new-outlet-ip">Shelly Outlet IP:</label>
          <input type="text" id="new-outlet-ip" placeholder="e.g., 192.168.1.100">
          <label for="new-outlet-label">Label (optional):</label>
          <input type="text" id="new-outlet-label" placeholder="e.g., Light Switch">
          <button type="button" id="add-outlet-btn">Add Outlet</button>
        </form>
      </div>
      <!-- Discord Notifications -->
      <div class="data-container">
        <h2>Discord Notifications</h2>
        <form id="discord-form">
          <label for="discord-enabled">Enable Discord Notifications:</label>
          <input type="checkbox" id="discord-enabled">
          <label for="discord-webhook-url">Discord Webhook URL:</label>
          <input type="text" id="discord-webhook-url" placeholder="https://discord.com/api/webhooks/...">
          <button type="submit">Save Discord Settings</button>
        </form>
        <div class="test-section">
          <h3>Test Discord</h3>
          <input type="text" id="discord-test-message" placeholder="Enter test message...">
          <button id="discord-test-send-btn">Send Test Message</button>
          <div id="discord-test-result"></div>
        </div>
      </div>
      <!-- Telegram Notifications -->
      <div class="data-container">
        <h2>Telegram Notifications</h2>
        <form id="telegram-form">
          <label for="telegram-enabled">Enable Telegram Notifications:</label>
          <input type="checkbox" id="telegram-enabled">
          <label for="telegram-bot-token">Telegram Bot Token:</label>
          <input type="text" id="telegram-bot-token" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
          <label for="telegram-chat-id">Telegram Chat ID:</label>
          <input type="text" id="telegram-chat-id" placeholder="e.g., -123456789 or @channelname">
          <button type="submit">Save Telegram Settings</button>
        </form>
        <div class="test-section">
          <h3>Test Telegram</h3>
          <input type="text" id="telegram-test-message" placeholder="Enter test message...">
          <button id="telegram-test-send-btn">Send Test Message</button>
          <div id="telegram-test-result"></div>
        </div>
      </div>
      <!-- Export/Import -->
      <div class="data-container">
        <h2>Export/Import Settings</h2>
        <button id="export-btn">Export Settings</button>
        <form id="import-form">
          <input type="file" id="import-file" accept=".json">
          <button type="submit">Import Settings</button>
        </form>
        <div id="import-status"></div>
      </div>
    </div>
  </main>
  <script>
    // JavaScript for Settings page (modified to remove moved items)
    // Fetch current settings on load
    document.addEventListener('DOMContentLoaded', () => {
      fetch('/api/settings')
        .then(response => response.json())
        .then(settings => {
          // USB Roles
          fetchUsbDevices();

          // pH Min/Max Range
          document.getElementById('ph-min').value = settings.ph_range.min || 5.5;
          document.getElementById('ph-max').value = settings.ph_range.max || 6.5;

          // General Settings (remaining)
          document.getElementById('ph-target').value = settings.ph_target || 5.8;
          document.getElementById('max-dosing').value = settings.max_dosing_amount || 5;
          document.getElementById('dosing-interval').value = settings.dosing_interval || 1.0;

          // Dosage Strength
          document.getElementById('ph-up-strength').value = settings.dosage_strength.ph_up || 1.3;
          document.getElementById('ph-down-strength').value = settings.dosage_strength.ph_down || 0.9;

          // System Name
          document.getElementById('system-name').value = settings.system_name || 'Garden';

          // Time Zone
          fetchTimeZones().then(timezones => {
            const tzSelect = document.getElementById('time-zone');
            timezones.forEach(tz => {
              const option = document.createElement('option');
              option.value = tz;
              option.textContent = tz;
              tzSelect.appendChild(option);
            });
            tzSelect.value = settings.time_zone || 'America/New_York';
          });
          document.getElementById('daylight-savings').checked = settings.daylight_savings_enabled || true;

          // Pump Calibration
          document.getElementById('pump1-calibration').value = settings.pump_calibration.pump1 || 0.5;
          document.getElementById('pump2-calibration').value = settings.pump_calibration.pump2 || 0.5;
          document.getElementById('pump1-last-calibrated').textContent = settings.pump_calibration.pump1_last_calibrated || 'N/A';
          document.getElementById('pump2-last-calibrated').textContent = settings.pump_calibration.pump2_last_calibrated || 'N/A';

          // Relay Ports
          document.getElementById('ph-up-port').value = settings.relay_ports.ph_up || 1;
          document.getElementById('ph-down-port').value = settings.relay_ports.ph_down || 2;

          // Power Controls
          renderPowerOutlets(settings.power_controls || []);

          // Discord
          document.getElementById('discord-enabled').checked = settings.discord_enabled || false;
          document.getElementById('discord-webhook-url').value = settings.discord_webhook_url || '';

          // Telegram
          document.getElementById('telegram-enabled').checked = settings.telegram_enabled || false;
          document.getElementById('telegram-bot-token').value = settings.telegram_bot_token || '';
          document.getElementById('telegram-chat-id').value = settings.telegram_chat_id || '';

          // Check if dosing relay is assigned
          if (!settings.usb_roles.relay) {
            disableDosingSections();
          }
        })
        .catch(err => console.error('Error fetching settings:', err));
    });

    // Function to disable dosing-related sections
    function disableDosingSections() {
      document.getElementById('ph-range-container').classList.add('disabled-section');
      document.getElementById('ph-range-container').setAttribute('data-disabled-title', 'Requires Dosing Relay Module');

      document.getElementById('general-settings-container').classList.add('disabled-section');
      document.getElementById('general-settings-container').setAttribute('data-disabled-title', 'Requires Dosing Relay Module');

      document.getElementById('dosage-strength-container').classList.add('disabled-section');
      document.getElementById('dosage-strength-container').setAttribute('data-disabled-title', 'Requires Dosing Relay Module');

      document.getElementById('pump-calibration-container').classList.add('disabled-section');
      document.getElementById('pump-calibration-container').setAttribute('data-disabled-title', 'Requires Dosing Relay Module');

      document.getElementById('relay-ports-container').classList.add('disabled-section');
      document.getElementById('relay-ports-container').setAttribute('data-disabled-title', 'Requires Dosing Relay Module');

      document.getElementById('relay-warning').style.display = 'block';
    }

    // Fetch USB devices
    function fetchUsbDevices() {
      fetch('/api/settings/usb_devices')
        .then(response => response.json())
        .then(data => {
          const phSelect = document.getElementById('ph-device');
          const dosingRelaySelect = document.getElementById('dosing-relay-device');
          const valveRelaySelect = document.getElementById('valve-relay-device');
          const ecMeterSelect = document.getElementById('ec-meter-device');

          phSelect.innerHTML = '<option value="">Select a device</option>';
          dosingRelaySelect.innerHTML = '<option value="">Select a device</option>';
          valveRelaySelect.innerHTML = '<option value="">Select a device</option>';
          ecMeterSelect.innerHTML = '<option value="">Select a device</option>';

          data.devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.path;
            option.textContent = device.name;
            phSelect.appendChild(option.cloneNode(true));
            dosingRelaySelect.appendChild(option.cloneNode(true));
            valveRelaySelect.appendChild(option.cloneNode(true));
            ecMeterSelect.appendChild(option.cloneNode(true));
          });

          // Set current values
          fetch('/api/settings')
            .then(r => r.json())
            .then(settings => {
              phSelect.value = settings.usb_roles.ph_probe || '';
              dosingRelaySelect.value = settings.usb_roles.relay || '';
              valveRelaySelect.value = settings.usb_roles.valve_relay || '';
              ecMeterSelect.value = settings.usb_roles.ec_meter || '';

              // Show/hide calibration link
              document.getElementById('ph-calibration-link').style.display = phSelect.value ? 'block' : 'none';

              // Show/hide valves link
              document.getElementById('valve-relay-link').style.display = valveRelaySelect.value ? 'block' : 'none';
            });
        })
        .catch(err => console.error('Error fetching USB devices:', err));
    }

    // Fetch time zones
    function fetchTimeZones() {
      return fetch('/api/device/timezones')
        .then(response => response.json())
        .then(data => data.timezones)
        .catch(err => {
          console.error('Error fetching time zones:', err);
          return [];
        });
    }

    // Render power outlets
    function renderPowerOutlets(powerControls) {
      const list = document.getElementById('power-outlets-list');
      list.innerHTML = '';
      powerControls.forEach((outlet, index) => {
        const card = document.createElement('div');
        card.classList.add('power-outlet-card');
        card.innerHTML = `
          <h4>${outlet.label || `Outlet ${index + 1}`}</h4>
          <p>IP: ${outlet.outlet_ip}</p>
          <button onclick="removeOutlet(${index})">Remove Outlet</button>
        `;
        list.appendChild(card);
      });
    }

    // Save settings generic function
    function saveSettings(url, payload) {
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(data => {
        if (data.status === 'success') {
          console.log('Settings saved successfully');
        } else {
          console.error('Failed to save settings:', data.error);
        }
      })
      .catch(err => console.error('Error saving settings:', err));
    }

    // Event listeners for forms (modified)
    // pH Form
    document.getElementById('ph-form').addEventListener('submit', e => {
      e.preventDefault();
      const device = document.getElementById('ph-device').value;
      saveSettings("/api/settings/usb_roles", { ph_probe: device });
    });

    // Dosing Relay Form
    document.getElementById('dosing-relay-form').addEventListener('submit', e => {
      e.preventDefault();
      const device = document.getElementById('dosing-relay-device').value;
      saveSettings("/api/settings/usb_roles", { relay: device });
    });

    // Valve Relay Form
    document.getElementById('valve-relay-form').addEventListener('submit', e => {
      e.preventDefault();
      const device = document.getElementById('valve-relay-device').value;
      saveSettings("/api/settings/usb_roles", { valve_relay: device });
    });

    // EC Meter Form
    document.getElementById('ec-meter-form').addEventListener('submit', e => {
      e.preventDefault();
      const device = document.getElementById('ec-meter-device').value;
      saveSettings("/api/settings/usb_roles", { ec_meter: device });
    });

    // pH Range Form
    document.getElementById('ph-range-form').addEventListener('submit', e => {
      e.preventDefault();
      const min = parseFloat(document.getElementById('ph-min').value);
      const max = parseFloat(document.getElementById('ph-max').value);
      saveSettings("/api/settings/", { ph_range: { min, max } });
    });

    // General Settings Form (remaining)
    document.getElementById('general-settings-form').addEventListener('submit', e => {
      e.preventDefault();
      const phTarget = parseFloat(document.getElementById('ph-target').value);
      const maxDosing = parseFloat(document.getElementById('max-dosing').value);
      const dosingInterval = parseFloat(document.getElementById('dosing-interval').value);
      const payload = {
        ph_target: phTarget,
        max_dosing_amount: maxDosing,
        dosing_interval: dosingInterval
      };
      saveSettings("/api/settings/", payload);
    });

    // Dosage Strength Form
    document.getElementById('dosage-strength-form').addEventListener('submit', e => {
      e.preventDefault();
      const phUp = parseFloat(document.getElementById('ph-up-strength').value);
      const phDown = parseFloat(document.getElementById('ph-down-strength').value);
      saveSettings("/api/settings/", { dosage_strength: { ph_up: phUp, ph_down: phDown } });
    });

    // System Name Form
    document.getElementById('system-name-form').addEventListener('submit', e => {
      e.preventDefault();
      const name = document.getElementById('system-name').value.trim();
      saveSettings("/api/settings/", { system_name: name });
    });

    // Time Zone Form
    document.getElementById('time-zone-form').addEventListener('submit', e => {
      e.preventDefault();
      const tz = document.getElementById('time-zone').value;
      const dst = document.getElementById('daylight-savings').checked;
      saveSettings("/api/settings/", { time_zone: tz, daylight_savings_enabled: dst });
    });

    // Pump Calibration Form
    document.getElementById('pump-calibration-form').addEventListener('submit', e => {
      e.preventDefault();
      const pump1 = parseFloat(document.getElementById('pump1-calibration').value);
      const pump2 = parseFloat(document.getElementById('pump2-calibration').value);
      saveSettings("/api/settings/", { pump_calibration: { pump1, pump2 } });
    });

    // Relay Ports Form
    document.getElementById('relay-ports-form').addEventListener('submit', e => {
      e.preventDefault();
      const phUp = parseInt(document.getElementById('ph-up-port').value);
      const phDown = parseInt(document.getElementById('ph-down-port').value);
      saveSettings("/api/settings/", { relay_ports: { ph_up: phUp, ph_down: phDown } });
    });

    // Discord Form + Test
    document.getElementById('discord-form').addEventListener('submit', e => {
      e.preventDefault();
      const enabled = document.getElementById('discord-enabled').checked;
      const webhook = document.getElementById('discord-webhook-url').value.trim();
      const payload = {
        discord_enabled: enabled,
        discord_webhook_url: webhook
      };
      saveSettings("/api/settings/", payload);
    });
    document.getElementById('discord-test-send-btn').addEventListener('click', () => {
      const testMessage = document.getElementById('discord-test-message').value.trim();
      if (!testMessage) {
        alert("Please enter a test message to send to Discord.");
        return;
      }
      // POST to /api/settings/test_discord
      fetch("/api/settings/discord_message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ test_message: testMessage })
      })
      .then(r => r.json())
      .then(data => {
        const resultDiv = document.getElementById('discord-test-result');
        if (data.status === "success") {
          resultDiv.style.color = "#7CFC00"; // greenish
          resultDiv.textContent = `Success: ${data.info || 'Message sent!'}`;
        } else {
          resultDiv.style.color = "#FF4444";
          resultDiv.textContent = `Failed: ${data.error || 'Unknown error'}`;
        }
      })
      .catch(err => {
        const resultDiv = document.getElementById('discord-test-result');
        resultDiv.style.color = "#FF4444";
        resultDiv.textContent = `Exception: ${err}`;
      });
    });

    // Telegram Form + Test
    document.getElementById('telegram-form').addEventListener('submit', e => {
      e.preventDefault();
      const enabled = document.getElementById('telegram-enabled').checked;
      const botToken = document.getElementById('telegram-bot-token').value.trim();
      const chatId = document.getElementById('telegram-chat-id').value.trim(); // <-- read the chat_id
      const payload = {
        telegram_enabled: enabled,
        telegram_bot_token: botToken,
        telegram_chat_id: chatId // <-- store the chat_id in settings
      };
      saveSettings("/api/settings/", payload);
    });
    document.getElementById('telegram-test-send-btn').addEventListener('click', () => {
      const testMessage = document.getElementById('telegram-test-message').value.trim();
      if (!testMessage) {
        alert("Please enter a test message for Telegram.");
        return;
      }
      // POST to /api/settings/test_telegram
      fetch("/api/settings/telegram_message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ test_message: testMessage })
      })
      .then(r => r.json())
      .then(data => {
        const resultDiv = document.getElementById('telegram-test-result');
        if (data.status === "success") {
          resultDiv.style.color = "#7CFC00"; // greenish
          resultDiv.textContent = `Success: ${data.info || 'Message sent!'}`;
        } else {
          resultDiv.style.color = "#FF4444";
          resultDiv.textContent = `Failed: ${data.error || 'Unknown error'}`;
        }
      })
      .catch(err => {
        const resultDiv = document.getElementById('telegram-test-result');
        resultDiv.style.color = "#FF4444";
        resultDiv.textContent = `Exception: ${err}`;
      });
    });
    // NEW: Add event listener for adding a new power outlet
    document.getElementById('add-outlet-btn').addEventListener('click', () => {
      const ip = document.getElementById('new-outlet-ip').value.trim();
      const label = document.getElementById('new-outlet-label').value.trim();
      if (!ip) {
        alert("Please enter an IP for the Shelly outlet.");
        return;
      }
      fetch('/api/settings')
        .then(r => r.json())
        .then(settings => {
          const powerControls = settings.power_controls || [];
          // Prevent duplicates by IP
          if (powerControls.some(outlet => outlet.outlet_ip === ip)) {
            alert("An outlet with that IP already exists.");
            return;
          }
          // Append the new outlet
          powerControls.push({
            outlet_ip: ip,
            label: label || `Outlet at ${ip}`,
            tracked_valves: [] // Start with no tracked valves
          });
          // Save the full updated list
          saveSettings("/api/settings/", { power_controls: powerControls });
          // Clear inputs
          document.getElementById('new-outlet-ip').value = '';
          document.getElementById('new-outlet-label').value = '';
        })
        .catch(err => console.error("Error adding outlet:", err));
    });

    // Export
    document.getElementById('export-btn').addEventListener('click', () => {
      window.location.href = '/api/settings/export';
    });

    // Import
    document.getElementById('import-form').addEventListener('submit', e => {
      e.preventDefault();
      const fileInput = document.getElementById('import-file');
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Please select a .json file first.");
        return;
      }
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      fetch('/api/settings/import', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          // Re-fetch or wait for status_update
          location.reload();
        } else {
          console.error("Failed to import settings:", data.error);
        }
      })
      .catch(err => console.error("Error importing settings:", err));
    });
  </script>
</body>
</html>