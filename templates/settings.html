<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>

    <!-- Navigation Menu -->
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/calibration">Calibration</a></li>
            <li><a href="/configuration">Configuration</a></li>
            <li><a href="/dosage">Dosage</a></li>
            <li><a href="/settings" class="active">Settings</a></li>
        </ul>
    </nav>

    <main>
        <h1>Settings</h1>
        <p class="subtitle">Configure your device, dosing, and sensors.</p>

        <div class="settings-grid">

            <!-- USB Device Assignment -->
            <div class="data-container">
                <h2>Assign USB Devices</h2>
                <form id="ph-form">
                    <label for="ph-device">pH Probe:</label>
                    <select id="ph-device" name="ph-device">
                        <option value="">Select a device</option>
                    </select>
                    <button type="submit">Save pH Probe</button>
                </form>

                <form id="relay-form">
                    <label for="relay-device">Relay Module:</label>
                    <select id="relay-device" name="relay-device">
                        <option value="">Select a device</option>
                    </select>
                    <button type="submit">Save Relay Module</button>
                </form>
                <button id="rescan-usb">Rescan USB Devices</button>
                <div id="status"></div>
                <div id="relay-warning" class="error-message" style="display: none;">
                    <strong>Relay module not assigned. Dosing-related settings are disabled.</strong>
                </div>
            </div>

            <!-- pH Min/Max Range -->
            <div class="data-container">
                <h2>pH Min/Max Range</h2>
                <form id="ph-range-form">
                    <label for="ph-min">pH Range - Min:</label>
                    <input type="number" id="ph-min" name="ph-min" step="0.01">

                    <label for="ph-max">pH Range - Max:</label>
                    <input type="number" id="ph-max" name="ph-max" step="0.01">

                    <button type="submit">Save pH Range</button>
                </form>
            </div>

            <!-- General Settings -->
            <div class="data-container">
                <h2>General Settings</h2>
                <form id="general-settings-form">
                    <label for="ph-target">pH Target:</label>
                    <input type="number" id="ph-target" name="ph-target" step="0.01" disabled>

                    <label for="max-dosing">Max Dosing Amount (ml):</label>
                    <input type="number" id="max-dosing" name="max-dosing" step="1" disabled>

                    <label for="dosing-interval">Dosing Interval (hours):</label>
                    <input type="number" id="dosing-interval" name="dosing-interval" step=".0001" disabled>

                    <label for="system-volume">System Volume (gallons):</label>
                    <input type="number" id="system-volume" name="system-volume" step=".1" disabled>

                    <label for="auto-dosing">Auto-Dosing Enabled:</label>
                    <input type="checkbox" id="auto-dosing" name="auto-dosing" disabled>

                    <button type="submit" id="general-save-btn" disabled>Save General Settings</button>
                </form>
            </div>

            <!-- Dosage Strength -->
            <div class="data-container">
                <h2>Dosage Strength</h2>
                <form id="dosage-strength-form">
                    <label for="ph-up-strength">pH Up Dosage Strength (ml per pH point):</label>
                    <input type="number" id="ph-up-strength" name="ph-up-strength" step="0.01" disabled>

                    <label for="ph-down-strength">pH Down Dosage Strength (ml per pH point):</label>
                    <input type="number" id="ph-down-strength" name="ph-down-strength" step="0.01" disabled>

                    <button type="submit" id="dosage-save-btn" disabled>Save Dosage Strength</button>
                </form>
            </div>

        </div>
    </main>

    <script>
        async function fetchSettings() {
            try {
                const response = await fetch("/api/settings");
                if (!response.ok) throw new Error("Failed to fetch settings");
                const settings = await response.json();

                // Assign values
                document.getElementById('ph-min').value = settings.ph_range?.min || '';
                document.getElementById('ph-max').value = settings.ph_range?.max || '';
                document.getElementById('ph-target').value = settings.ph_target || '5.8';
                document.getElementById('max-dosing').value = settings.max_dosing_amount || '0';
                document.getElementById('dosing-interval').value = settings.dosing_interval || '1';
                document.getElementById('system-volume').value = settings.system_volume || '';
                document.getElementById('auto-dosing').checked = !!settings.auto_dosing_enabled;
                document.getElementById('ph-up-strength').value = settings.dosage_strength?.ph_up || '';
                document.getElementById('ph-down-strength').value = settings.dosage_strength?.ph_down || '';

            } catch (error) {
                console.error("Error fetching settings:", error);
            }
        }

        async function fetchUsbDevices() {
            try {
                const response = await fetch("/api/settings/usb_devices");
                if (!response.ok) throw new Error("Failed to fetch USB devices");
                const devices = await response.json();

                const phDropdown = document.getElementById('ph-device');
                const relayDropdown = document.getElementById('relay-device');
                phDropdown.innerHTML = '<option value="">Select a device</option>';
                relayDropdown.innerHTML = '<option value="">Select a device</option>';

                devices.forEach(device => {
                    const option = new Option(device.device, device.device);
                    phDropdown.appendChild(option);
                    relayDropdown.appendChild(option.cloneNode(true));
                });
            } catch (error) {
                console.error("Error fetching USB devices:", error);
            }
        }

        document.getElementById('rescan-usb').addEventListener('click', fetchUsbDevices);
        document.getElementById('ph-form').addEventListener('submit', e => e.preventDefault());
        document.getElementById('relay-form').addEventListener('submit', e => e.preventDefault());

        document.addEventListener('DOMContentLoaded', () => {
            fetchSettings();
            fetchUsbDevices();
        });
    </script>

</body>
</html>
