<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Notifications</title>
    <!-- Load Socket.IO -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>
<h1>Notifications</h1>

<table id="notifications-table" border="1" cellpadding="6" cellspacing="0">
  <thead>
    <tr>
      <th>Device</th>
      <th>Key</th>
      <th>State</th>
      <th>Message</th>
      <th>Timestamp</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <!-- We'll fill this with JavaScript -->
  </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // 1) Connect to the /status namespace
  const socket = io.connect(window.location.origin + "/status");

  // 2) Confirm successful connection in the browser console
  socket.on("connect", () => {
    console.log("[CLIENT] Connected to /status namespace!");
  });

  // 3) Whenever the server emits "notifications_update", re-render table
  socket.on("notifications_update", (data) => {
    console.log("[WS] notifications_update => updating notifications from event data.");
    // data should contain something like: { notifications: [ ... ] }
    if (data.notifications) {
      renderNotifications(data.notifications);
    }
  });

  // 4) Fetch the notifications once on page load
  fetchNotifications();
});

/**
 * Fetch the notifications from /api/notifications
 */
async function fetchNotifications() {
  try {
    const resp = await fetch("/api/notifications");
    const data = await resp.json();
    if (data.status === "success") {
      renderNotifications(data.notifications);
    } else {
      console.error("Failed to load notifications:", data);
    }
  } catch (err) {
    console.error("Error fetching notifications:", err);
  }
}

/**
 * Renders the notifications table body
 */
function renderNotifications(notifs) {
  const tbody = document.querySelector("#notifications-table tbody");
  tbody.innerHTML = ""; // Clear old rows

  notifs.forEach(n => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${n.device}</td>
      <td>${n.key}</td>
      <td>${n.state}</td>
      <td>${n.message}</td>
      <td>${n.timestamp}</td>
      <td>
        <button onclick="clearNotification('${n.device}', '${n.key}')">
          Clear
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/**
 * Sends a POST to clear an individual notification,
 * then re-fetches the table
 */
async function clearNotification(device, key) {
  try {
    const resp = await fetch("/api/notifications/clear", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ device, key })
    });
    const data = await resp.json();
    if (data.status === "success") {
      // Once cleared, you can either:
      //  1) Re-fetch notifications
      //  2) Or rely on the server to emit "notifications_update" automatically
      //     if you coded that in Python. Here we'll just fetch again to be safe.
      fetchNotifications();
    } else {
      console.error("Failed to clear notification:", data);
    }
  } catch (err) {
    console.error("Error clearing notification:", err);
  }
}
</script>

</body>
</html>
