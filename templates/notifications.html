<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Notifications</title>
    <!-- You will need socket.io. E.g. -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>
<h1>Notifications</h1>

<table id="notifications-table" border="1" cellpadding="6" cellspacing="0">
  <thead>
    <tr>
      <th>Device</th>
      <th>Key</th>
      <th>State</th>
      <th>Message</th>
      <th>Timestamp</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <!-- We'll fill this with JavaScript -->
  </tbody>
</table>

<script>
let socket;

document.addEventListener("DOMContentLoaded", () => {
  // 1) Fetch notifications once on page load
  fetchNotifications();

  // 2) Connect to WebSocket / Socket.IO
  // This connects specifically to the /status namespace, matching your Python code.
  socket = io.connect(window.location.origin + "/status");


  // 3) Listen for "notifications_update" event from the server
  socket.on("notifications_update", data => {
    // Whenever the server says notifications changed, let's re-fetch
    console.log("[WS] notifications_update event => re-fetching notifications.");
    fetchNotifications();
  });
});

socket.on("connect", () => {
  console.log("[CLIENT] Connected to the /status namespace!");
});

/**
 * Fetch the notifications from /api/notifications
 */
async function fetchNotifications() {
  try {
    const resp = await fetch("/api/notifications");
    const data = await resp.json();
    if (data.status === "success") {
      renderNotifications(data.notifications);
    } else {
      console.error("Failed to load notifications", data);
    }
  } catch (err) {
    console.error("Error fetching notifications:", err);
  }
}

/**
 * Renders the notifications table body
 */
function renderNotifications(notifs) {
  const tbody = document.querySelector("#notifications-table tbody");
  tbody.innerHTML = ""; // Clear old rows

  notifs.forEach(n => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${n.device}</td>
      <td>${n.key}</td>
      <td>${n.state}</td>
      <td>${n.message}</td>
      <td>${n.timestamp}</td>
      <td>
        <button onclick="clearNotification('${n.device}', '${n.key}')">
          Clear
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/**
 * Sends a POST to clear an individual notification,
 * then re-fetches the table
 */
async function clearNotification(device, key) {
  try {
    const resp = await fetch("/api/notifications/clear", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ device, key })
    });
    const data = await resp.json();
    if (data.status === "success") {
      fetchNotifications(); // refresh after clearing
    } else {
      console.error("Failed to clear notification", data);
    }
  } catch (err) {
    console.error("Error clearing notification:", err);
  }
}
</script>

</body>
</html>
