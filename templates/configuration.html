<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- Navigation Menu -->
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/calibration">Calibration</a></li>
            <li><a href="/configuration" class="active">Configuration</a></li>
            <li><a href="/dosage">Dosage</a></li>
            <li><a href="/settings">Settings</a></li>
        </ul>
    </nav>

    <main>
        <h1>Device Configuration</h1>
        <p class="subtitle">Manage network, hostname, and time settings.</p>

        <!-- Hostname -->
        <div class="data-container">
            <h2>Hostname</h2>
            <input type="text" id="hostname" name="hostname" placeholder="Enter hostname">
            <button id="save-hostname">Save</button>
        </div>

        <!-- Time Configuration -->
        <div class="data-container">
            <h2>Time Configuration</h2>
            <label for="timezone-select">Time Zone:</label>
            <select id="timezone-select">
                <option value="">Loading timezones...</option>
            </select>

            <label>Currently in Daylight Savings:</label>
            <input type="checkbox" id="daylight-savings" disabled>

            <input type="text" id="ntp-server" placeholder="NTP Server">
            <button id="save-time">Save</button>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            async function fetchConfig() {
                try {
                    const response = await fetch('/api/device/config');
                    const data = await response.json();

                    if (data.status === 'success') {
                        const config = data.config;

                        // Hostname
                        document.getElementById("hostname").value = config.hostname || "";

                        // Time Configuration
                        window.currentTZ = config.timezone || "";
                        document.getElementById("daylight-savings").checked = config.daylight_savings || false;
                        document.getElementById("ntp-server").value = config.ntp_server || "";
                    }
                } catch (error) {
                    console.error("Error fetching configuration:", error);
                }
            }

            // Fetch and Populate Time Zones
            async function fetchTimezones() {
                try {
                    const response = await fetch('/api/device/timezones');
                    const data = await response.json();

                    if (data.status === 'success') {
                        const timezones = data.timezones || [];
                        const tzSelect = document.getElementById("timezone-select");
                        tzSelect.innerHTML = ""; // Clear existing

                        timezones.forEach(tz => {
                            const option = document.createElement("option");
                            option.value = tz;
                            option.textContent = tz;
                            tzSelect.appendChild(option);
                        });

                        // Select the current timezone
                        if (window.currentTZ) {
                            tzSelect.value = window.currentTZ;
                        }
                    } else {
                        console.error("Failed to fetch timezones:", data.message);
                    }
                } catch (error) {
                    console.error("Error fetching timezones:", error);
                }
            }

            async function saveConfig(endpoint, payload) {
                try {
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    const data = await response.json();
                    alert(data.message);
                } catch (error) {
                    console.error("Error saving config:", error);
                }
            }

            document.getElementById("save-hostname").addEventListener("click", () => {
                saveConfig('/api/device/config', { hostname: document.getElementById("hostname").value });
            });

            document.getElementById("save-time").addEventListener("click", () => {
                const selectedTZ = document.getElementById("timezone-select").value;
                const ntp = document.getElementById("ntp-server").value;

                saveConfig('/api/device/config', {
                    timezone: selectedTZ,
                    daylight_savings: document.getElementById("daylight-savings").checked,
                    ntp_server: ntp
                });
            });

            await fetchConfig();
            await fetchTimezones();
        });
    </script>

</body>
</html>
