<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- Navigation Menu -->
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/calibration">Calibration</a></li>
            <li><a href="/configuration" class="active">Configuration</a></li>
            <li><a href="/dosage">Dosage</a></li>
            <li><a href="/settings">Settings</a></li>
        </ul>
    </nav>

    <main>
        <h1>Device Configuration</h1>
        <p class="subtitle">Manage network, hostname, and time settings.</p>

        <!-- Hostname -->
        <div class="data-container">
            <h2>Hostname</h2>
            <input type="text" id="hostname" name="hostname" placeholder="Enter hostname">
            <button id="save-hostname">Save</button>
        </div>

        <!-- Network Configuration -->
        <div class="data-container">
            <h2>Network Configuration</h2>

            <!-- Ethernet (eth0) -->
            <h3>Ethernet (eth0)</h3>
            <label class="checkbox-container">
                <input type="checkbox" id="eth0-dhcp"> Enable DHCP
            </label>
            <div id="eth0-static-config" class="static-config">
                <input type="text" id="eth0-ip" placeholder="IP Address">
                <input type="text" id="eth0-subnet" placeholder="Subnet Mask">
                <input type="text" id="eth0-gateway" placeholder="Gateway">
                <input type="text" id="eth0-dns1" placeholder="DNS Server 1">
                <input type="text" id="eth0-dns2" placeholder="DNS Server 2">
            </div>
            <button id="save-eth0">Save</button>

            <!-- Wi-Fi (wlan0) -->
            <h3>Wi-Fi (wlan0)</h3>
            <label class="checkbox-container">
                <input type="checkbox" id="wlan0-dhcp"> Enable DHCP
            </label>
            <div id="wlan0-static-config" class="static-config">
                <input type="text" id="wlan0-ip" placeholder="IP Address">
                <input type="text" id="wlan0-subnet" placeholder="Subnet Mask">
                <input type="text" id="wlan0-gateway" placeholder="Gateway">
                <input type="text" id="wlan0-dns1" placeholder="DNS Server 1">
                <input type="text" id="wlan0-dns2" placeholder="DNS Server 2">
            </div>
            <input type="text" id="wifi-ssid" placeholder="WiFi SSID">
            <input type="password" id="wifi-password" placeholder="WiFi Password">
            <button id="save-wlan0">Save</button>
        </div>

        <!-- Time Configuration -->
        <div class="data-container">
            <h2>Time Configuration</h2>
            <label for="timezone-select">Time Zone:</label>
            <select id="timezone-select">
                <option value="">Loading timezones...</option>
            </select>

            <label>Currently in Daylight Savings:</label>
            <input type="checkbox" id="daylight-savings" disabled>

            <input type="text" id="ntp-server" placeholder="NTP Server">
            <button id="save-time">Save</button>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            async function fetchConfig() {
                try {
                    const response = await fetch('/api/device/config');
                    const data = await response.json();

                    if (data.status === 'success') {
                        const config = data.config;

                        // Hostname
                        document.getElementById("hostname").value = config.hostname || "";

                        // Ethernet (eth0)
                        const eth0 = config.eth0;
                        document.getElementById("eth0-dhcp").checked = eth0.dhcp || false;
                        toggleStaticConfig("eth0", eth0.dhcp);
                        if (!eth0.dhcp) {
                            document.getElementById("eth0-ip").value = eth0.ip_address || "";
                            document.getElementById("eth0-subnet").value = eth0.subnet_mask || "";
                            document.getElementById("eth0-gateway").value = eth0.gateway || "";
                            document.getElementById("eth0-dns1").value = eth0.dns1 || "";
                            document.getElementById("eth0-dns2").value = eth0.dns2 || "";
                        }

                        // Wi-Fi (wlan0)
                        const wlan0 = config.wlan0;
                        document.getElementById("wlan0-dhcp").checked = wlan0.dhcp || false;
                        toggleStaticConfig("wlan0", wlan0.dhcp);
                        if (!wlan0.dhcp) {
                            document.getElementById("wlan0-ip").value = wlan0.ip_address || "";
                            document.getElementById("wlan0-subnet").value = wlan0.subnet_mask || "";
                            document.getElementById("wlan0-gateway").value = wlan0.gateway || "";
                            document.getElementById("wlan0-dns1").value = wlan0.dns1 || "";
                            document.getElementById("wlan0-dns2").value = wlan0.dns2 || "";
                        }
                        document.getElementById("wifi-ssid").value = wlan0.ssid || "";

                        // Time config
                        window.currentTZ = config.timezone || "";
                        document.getElementById("daylight-savings").checked = config.daylight_savings || false;
                        document.getElementById("ntp-server").value = config.ntp_server || "";
                    }
                } catch (error) {
                    console.error("Error fetching configuration:", error);
                }
            }

            function toggleStaticConfig(iface, isDhcp) {
                document.getElementById(`${iface}-static-config`).style.display = isDhcp ? "none" : "block";
            }

            async function saveConfig(endpoint, payload) {
                try {
                    const response = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });
                    const data = await response.json();
                    alert(data.message);
                } catch (error) {
                    console.error("Error saving config:", error);
                }
            }

            document.getElementById("save-hostname").addEventListener("click", () => {
                saveConfig('/api/device/config', { hostname: document.getElementById("hostname").value });
            });

            document.getElementById("save-eth0").addEventListener("click", () => {
                saveConfig('/api/device/config', {
                    interface: 'eth0',
                    dhcp: document.getElementById("eth0-dhcp").checked,
                    ip_address: document.getElementById("eth0-ip").value,
                    subnet_mask: document.getElementById("eth0-subnet").value,
                    gateway: document.getElementById("eth0-gateway").value,
                    dns1: document.getElementById("eth0-dns1").value,
                    dns2: document.getElementById("eth0-dns2").value,
                });
            });

            document.getElementById("save-wlan0").addEventListener("click", () => {
                saveConfig('/api/device/config', {
                    interface: 'wlan0',
                    dhcp: document.getElementById("wlan0-dhcp").checked,
                    wifi_ssid: document.getElementById("wifi-ssid").value,
                    wifi_password: document.getElementById("wifi-password").value,
                });
            });

            await fetchConfig();
        });
    </script>

</body>
</html>
