<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Valve Control</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- import the Socket.IO client library -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>

  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/calibration">Calibration</a></li>
      <li><a href="/configuration">Configuration</a></li>
      <li><a href="/dosage">Dosage</a></li>
      <li><a href="/settings">Settings</a></li>
      <li><a href="/valves">Valves</a></li>
    </ul>
  </nav>

  <main>
    <h1>Valve Control</h1>
    <p>This page allows you to name each valve and turn them on/off.</p>

    <table id="valve-table" border="1" cellpadding="8" cellspacing="0">
      <thead>
        <tr>
          <th>Valve Label</th>
          <th>Rename</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be populated by JavaScript -->
      </tbody>
    </table>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 1) Do the initial fetch to populate the table
      fetchValveStatus();

      // 2) Set up our WebSocket (Socket.IO) connection for real-time updates
      const socket = io("/status");  // '/status' must match your server's namespace

      socket.on("connect", () => {
        console.log("[valves.html] Connected to /status via Socket.IO");
      });

      socket.on("disconnect", () => {
        console.log("[valves.html] Disconnected from /status");
      });

      // 3) On each "status_update", see if there's valve info => update the table
      socket.on("status_update", (data) => {
        // Check if 'valve_info' and 'valve_relays' exist
        if (data.valve_info && data.valve_info.valve_relays) {
          const relays = data.valve_info.valve_relays; 
          // relays is like {"Zone 1 Drain": {status: "off"}, "Zone 2 Drain": {...}, ...}
          for (let labelKey in relays) {
            const relay = relays[labelKey];
            const newStatus = relay.status || "off";
            // Update the table cell for that label (if it exists)
            const statusCell = document.getElementById(`valve-status-${labelKey}`);
            if (statusCell) {
              statusCell.textContent = newStatus;
            }
            // Color the On/Off buttons
            updateValveDisplay(labelKey, newStatus.toLowerCase());
          }
        }
      });
    });

    // ============== Populate table from a JSON endpoint =============
    function fetchValveStatus() {
      fetch("/api/valve_relay/all_status")
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            // data.valves is presumably something like:
            // {
            //   "Zone 1 Drain": {"status": "off"},
            //   "Zone 2 Drain": {"status": "on"},
            //   ...
            // }
            populateTable(data.valves);
          } else {
            console.error("Failed to fetch valve status:", data.error);
          }
        })
        .catch(err => {
          console.error("Error fetching valve status:", err);
        });
    }

    function populateTable(valves) {
      const tbody = document.querySelector("#valve-table tbody");
      tbody.innerHTML = ""; // Clear existing rows

      // 'valveKey' will be something like "Zone 4 Drain"
      Object.keys(valves).forEach(valveKey => {
        const info = valves[valveKey];
        const status = info.status || "unknown";

        const tr = document.createElement('tr');

        // (A) Valve label cell
        const labelCell = document.createElement('td');
        labelCell.textContent = valveKey;  // "Zone 4 Drain"
        tr.appendChild(labelCell);

        // (B) Label rename cell (optional if you still want to rename by the key)
        // You might remove or adapt this if your "label is key" approach doesn't allow dynamic renaming
        const renameCell = document.createElement('td');
        const renameWrapper = document.createElement('div');
        renameWrapper.style.display = "inline-flex";
        renameWrapper.style.gap = "8px";

        const renameInput = document.createElement('input');
        renameInput.type = "text";
        renameInput.value = valveKey;
        renameInput.id = `valve-rename-${valveKey}`;
        renameInput.style.width = "180px";

        const saveBtn = document.createElement('button');
        saveBtn.textContent = "Save";
        saveBtn.onclick = () => saveLabel(valveKey);

        renameWrapper.appendChild(renameInput);
        renameWrapper.appendChild(saveBtn);
        renameCell.appendChild(renameWrapper);
        tr.appendChild(renameCell);

        // (C) Status cell
        const statusCell = document.createElement('td');
        statusCell.id = `valve-status-${valveKey}`;
        statusCell.textContent = status;
        tr.appendChild(statusCell);

        // (D) Action cell (On/Off)
        const actionCell = document.createElement('td');
        const onBtn = document.createElement('button');
        onBtn.textContent = "ON";
        onBtn.id = `valve-${valveKey}-on`;
        onBtn.onclick = () => turnValveOn(valveKey);

        const offBtn = document.createElement('button');
        offBtn.textContent = "OFF";
        offBtn.id = `valve-${valveKey}-off`;
        offBtn.onclick = () => turnValveOff(valveKey);

        actionCell.appendChild(onBtn);
        actionCell.appendChild(offBtn);
        tr.appendChild(actionCell);

        tbody.appendChild(tr);

        updateValveDisplay(valveKey, status.toLowerCase());
      });
    }

    // ============== Example: rename the valve key (if you allow that) =============
    function saveLabel(oldLabel) {
      const newLabel = document.getElementById(`valve-rename-${oldLabel}`).value;
      // If your backend still expects numeric IDs or some unique ID, you'll need to adapt this.
      // For now, we assume there's an endpoint that can rename from oldLabel->newLabel
      fetch(`/api/valve_relay/rename`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ old_label: oldLabel, new_label: newLabel })
      })
      .then(r => r.json())
      .then(data => {
        if (data.status === "success") {
          console.log(`Renamed valve from "${oldLabel}" to "${newLabel}"`);
          // Possibly re-fetch or reload the table
          fetchValveStatus();
        } else {
          console.error("Failed to rename label:", data.error);
        }
      })
      .catch(err => console.error("Error renaming label:", err));
    }

    // ============== Turn valve on/off by label =============
    function turnValveOn(label) {
      fetch(`/api/valve_relay/${encodeURIComponent(label)}/on`, {method: "POST"})
        .then(r => r.json())
        .then(data => {
          if (data.status === "success") {
            document.getElementById(`valve-status-${label}`).textContent = "on";
            updateValveDisplay(label, "on");
          } else {
            console.error("Failed to turn valve on:", data.error);
          }
        })
        .catch(err => console.error("Error turning valve on:", err));
    }

    function turnValveOff(label) {
      fetch(`/api/valve_relay/${encodeURIComponent(label)}/off`, {method: "POST"})
        .then(r => r.json())
        .then(data => {
          if (data.status === "success") {
            document.getElementById(`valve-status-${label}`).textContent = "off";
            updateValveDisplay(label, "off");
          } else {
            console.error("Failed to turn valve off:", data.error);
          }
        })
        .catch(err => console.error("Error turning valve off:", err));
    }

    // ============== UI styling for on/off buttons =============
    function updateValveDisplay(label, newStatus) {
      const onButton  = document.getElementById(`valve-${label}-on`);
      const offButton = document.getElementById(`valve-${label}-off`);
      if (!onButton || !offButton) return;

      onButton.classList.remove("btn-on-active","btn-off-active","btn-inactive");
      offButton.classList.remove("btn-on-active","btn-off-active","btn-inactive");

      if (newStatus === "on") {
        onButton.classList.add("btn-on-active");
        offButton.classList.add("btn-inactive");
      } else {
        onButton.classList.add("btn-inactive");
        offButton.classList.add("btn-off-active");
      }
    }
  </script>
</body>
</html>
