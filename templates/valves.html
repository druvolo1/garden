<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Valve Control</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- import the Socket.IO client library -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>

  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/calibration">Calibration</a></li>
      <li><a href="/configuration">Configuration</a></li>
      <li><a href="/dosage">Dosage</a></li>
      <li><a href="/settings">Settings</a></li>
      <li><a href="/valves">Valves</a></li>
    </ul>
  </nav>

  <main>
    <h1>Valve Control</h1>
    <p>This page allows you to name each valve and turn them on/off.</p>

    <table id="valve-table" border="1" cellpadding="8" cellspacing="0">
      <thead>
        <tr>
          <th>Valve ID</th>
          <th>Rename (Label)</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be populated by JavaScript -->
      </tbody>
    </table>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 1) Initial fetch to populate the table
      fetchValveStatus();

      // 2) Set up Socket.IO for real-time status updates
      const socket = io("/status");  // '/status' must match your server's namespace
      socket.on("connect", () => {
        console.log("[valves.html] Connected to /status via Socket.IO");
      });
      socket.on("disconnect", () => {
        console.log("[valves.html] Disconnected from /status");
      });

      // 3) On each "status_update", if there's valve info, update the table
      socket.on("status_update", (data) => {
        if (data.valve_info && data.valve_info.valve_relays) {
          const relays = data.valve_info.valve_relays; 
          // relays might look like {"Zone 1 Drain": {status:"off"}, ...} if label-based,
          // or "Valve #1": {status:"on"} if ID-based. But your aggregator is label-based.
          // If your aggregator is numeric-based, adapt accordingly.
          // In your case, the aggregator might be label-based, so this direct
          // mapping might need a tweak. If the aggregator is numeric-based, it matches below.
          // 
          // Check your aggregator to confirm. If the aggregator is using numeric ID keys,
          // you can do the same approach as below. Otherwise, you might need to re-map.
          // 
          // For now, let's assume it's numeric-based. 
          for (let numericId in relays) {
            const relay = relays[numericId];
            const newStatus = relay.status || "off";
            const statusCell = document.getElementById(`valve-status-${numericId}`);
            if (statusCell) {
              statusCell.textContent = newStatus;
            }
            updateValveDisplay(numericId, newStatus.toLowerCase());
          }
        }
      });
    });

    // ============== 1) Fetch numeric-based statuses =============
    function fetchValveStatus() {
      fetch("/api/valve_relay/all_status")
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            // data.valves might be:
            // {
            //   "1": { "label": "Zone 1 Drain", "status": "off" },
            //   "2": { "label": "Zone 2 Drain", "status": "on" },
            //   ...
            // }
            populateTable(data.valves);
          } else {
            console.error("Failed to fetch valve status:", data.error);
          }
        })
        .catch(err => {
          console.error("Error fetching valve status:", err);
        });
    }

    // ============== 2) Build the table =============
    function populateTable(valves) {
      const tbody = document.querySelector("#valve-table tbody");
      tbody.innerHTML = ""; // Clear existing rows

      // valveKey is the numeric ID as a string, e.g. "1", "2", ...
      Object.keys(valves).forEach(valveKey => {
        const info = valves[valveKey];
        const label = info.label || `Valve ${valveKey}`;
        const status = info.status || "unknown";

        const tr = document.createElement('tr');

        // Column A: Valve ID (the numeric key)
        const idCell = document.createElement('td');
        idCell.textContent = valveKey;  
        tr.appendChild(idCell);

        // Column B: Rename input (current label)
        const renameCell = document.createElement('td');
        const renameWrapper = document.createElement('div');
        renameWrapper.style.display = "inline-flex";
        renameWrapper.style.gap = "8px";

        const renameInput = document.createElement('input');
        renameInput.type = "text";
        renameInput.value = label;
        renameInput.id = `valve-rename-${valveKey}`;
        renameInput.style.width = "180px";

        const saveBtn = document.createElement('button');
        saveBtn.textContent = "Save";
        // On click => call saveLabel(valveKey)
        saveBtn.onclick = () => saveLabel(valveKey);

        renameWrapper.appendChild(renameInput);
        renameWrapper.appendChild(saveBtn);
        renameCell.appendChild(renameWrapper);
        tr.appendChild(renameCell);

        // Column C: Status
        const statusCell = document.createElement('td');
        statusCell.id = `valve-status-${valveKey}`;
        statusCell.textContent = status;
        tr.appendChild(statusCell);

        // Column D: Action buttons (On/Off)
        const actionCell = document.createElement('td');
        const onBtn = document.createElement('button');
        onBtn.textContent = "ON";
        onBtn.id = `valve-${valveKey}-on`;
        onBtn.onclick = () => turnValveOn(valveKey);

        const offBtn = document.createElement('button');
        offBtn.textContent = "OFF";
        offBtn.id = `valve-${valveKey}-off`;
        offBtn.onclick = () => turnValveOff(valveKey);

        actionCell.appendChild(onBtn);
        actionCell.appendChild(offBtn);
        tr.appendChild(actionCell);

        // Add row to table
        tbody.appendChild(tr);

        // Update button styles
        updateValveDisplay(valveKey, status.toLowerCase());
      });
    }

    // ============== 3) Rename a valve by numeric ID =============
    function saveLabel(valveId) {
      // Read the new label from the input
      const newLabel = document.getElementById(`valve-rename-${valveId}`).value.trim();
      if (!newLabel) {
        alert("Please enter a label.");
        return;
      }
      // POST to /api/valve_relay/label/<valve_id>
      fetch(`/api/valve_relay/label/${valveId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ label: newLabel })
      })
      .then(r => r.json())
      .then(data => {
        if (data.status === "success") {
          console.log(`Renamed valve #${valveId} to "${newLabel}".`);
          // Refresh table
          fetchValveStatus();
        } else {
          console.error("Failed to rename label:", data.error);
        }
      })
      .catch(err => console.error("Error renaming valve:", err));
    }

    // ============== 4) Turn valve on/off by numeric ID =============
    function turnValveOn(valveId) {
      // Calls /api/valve_relay/<int:valveId>/on
      fetch(`/api/valve_relay/${encodeURIComponent(valveId)}/on`, { method: "POST" })
        .then(r => r.json())
        .then(data => {
          if (data.status === "success") {
            document.getElementById(`valve-status-${valveId}`).textContent = "on";
            updateValveDisplay(valveId, "on");
          } else {
            console.error("Failed to turn valve on:", data.error);
          }
        })
        .catch(err => console.error("Error turning valve on:", err));
    }

    function turnValveOff(valveId) {
      fetch(`/api/valve_relay/${encodeURIComponent(valveId)}/off`, { method: "POST" })
        .then(r => r.json())
        .then(data => {
          if (data.status === "success") {
            document.getElementById(`valve-status-${valveId}`).textContent = "off";
            updateValveDisplay(valveId, "off");
          } else {
            console.error("Failed to turn valve off:", data.error);
          }
        })
        .catch(err => console.error("Error turning valve off:", err));
    }

    // ============== 5) UI styling for On/Off buttons =============
    function updateValveDisplay(valveId, newStatus) {
      const onButton  = document.getElementById(`valve-${valveId}-on`);
      const offButton = document.getElementById(`valve-${valveId}-off`);
      if (!onButton || !offButton) return;

      onButton.classList.remove("btn-on-active","btn-off-active","btn-inactive");
      offButton.classList.remove("btn-on-active","btn-off-active","btn-inactive");

      if (newStatus === "on") {
        onButton.classList.add("btn-on-active");
        offButton.classList.add("btn-inactive");
      } else {
        onButton.classList.add("btn-inactive");
        offButton.classList.add("btn-off-active");
      }
    }
  </script>
</body>
</html>
