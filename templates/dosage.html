<!-- templates/dosage.html (excerpt) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dosage Info</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/calibration">Calibration</a></li>
            <li><a href="/settings">Settings</a></li>
            <li><a href="/dosage">Dosage</a></li>
        </ul>
    </nav>

    <h1>Dosage Status</h1>

    <p><strong>Current pH:</strong> {{ dosage_data.current_ph }}</p>
    <p><strong>System Volume:</strong> {{ dosage_data.system_volume }}</p>
    <p><strong>Auto Dosing Enabled:</strong> {{ dosage_data.auto_dosing_enabled }}</p>
    <p><strong>pH Target:</strong> {{ dosage_data.ph_target }}</p>

    <hr>

    <!-- pH Up Section -->
    <h2>pH Up Dosing</h2>
    <p>
        <strong>Calculated Amount:</strong>
        <span id="ph-up-amount">{{ dosage_data.ph_up_amount }}</span> ml
    </p>
    {% if dosage_data.feedback_up %}
        <p style="color: red;">
            <!-- Mark as safe to allow HTML inside the feedback message -->
            {{ dosage_data.feedback_up|safe }}
        </p>
    {% endif %}
    <button id="ph-up-dispense">Dispense pH Up</button>

    <hr>

    <!-- pH Down Section -->
    <h2>pH Down Dosing</h2>
    <p>
        <strong>Calculated Amount:</strong>
        <span id="ph-down-amount">{{ dosage_data.ph_down_amount }}</span> ml
    </p>
    {% if dosage_data.feedback_down %}
        <p style="color: red;">
            {{ dosage_data.feedback_down|safe }}
        </p>
    {% endif %}
    <button id="ph-down-dispense">Dispense pH Down</button>

    <script>
    $(document).ready(function() {
        // pH Up button
        $('#ph-up-dispense').on('click', function() {
            const amount = parseFloat($('#ph-up-amount').text()) || 0;
            if (amount === 0) {
                alert("No pH Up required (0 ml).");
                return;
            }
            $.ajax({
                url: '/api/dosage/manual',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ type: 'up', amount: amount }),
                success: function(response) {
                    alert("Manual pH Up dispense triggered: " + response.message);
                },
                error: function(error) {
                    console.error("Error dispensing pH Up:", error);
                    alert("Failed to dispense pH Up.");
                }
            });
        });

        // pH Down button
        $('#ph-down-dispense').on('click', function() {
            const amount = parseFloat($('#ph-down-amount').text()) || 0;
            if (amount === 0) {
                alert("No pH Down required (0 ml).");
                return;
            }
            $.ajax({
                url: '/api/dosage/manual',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ type: 'down', amount: amount }),
                success: function(response) {
                    alert("Manual pH Down dispense triggered: " + response.message);
                },
                error: function(error) {
                    console.error("Error dispensing pH Down:", error);
                    alert("Failed to dispense pH Down.");
                }
            });
        });
    });
    </script>
</body>
</html>
