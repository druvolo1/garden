<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Controls</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <script>
        async function toggleDebug(component) {
            const button = document.getElementById(`toggle-${component}`);
            const currentState = button.classList.contains("btn-on-active");
            const newState = !currentState;

            // Update UI Immediately
            button.classList.toggle("btn-on-active", newState);
            button.classList.toggle("btn-off-active", !newState);
            button.innerText = newState ? "ON" : "OFF";

            // Send update to server
            try {
                await fetch(`/debug/toggle`, {  // ðŸ”§ FIXED API ENDPOINT
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ component: component, enabled: newState }) // ðŸ”§ FIXED JSON KEYS
                });
            } catch (error) {
                console.error("Error updating debug state:", error);
                alert("Failed to update debug state. Check the console for details.");
            }
        }

        async function fetchDebugStates() {
            try {
                const response = await fetch("/debug/status");  // ðŸ”§ FIXED API ENDPOINT
                const debugStates = await response.json();

                for (const component in debugStates) {
                    const button = document.getElementById(`toggle-${component}`);
                    if (button) {
                        const isEnabled = debugStates[component];
                        button.classList.toggle("btn-on-active", isEnabled);
                        button.classList.toggle("btn-off-active", !isEnabled);
                        button.innerText = isEnabled ? "ON" : "OFF";
                    }
                }
            } catch (error) {
                console.error("Error fetching debug states:", error);
            }
        }

        async function fetchAutoDoseState() {
            try {
                const response = await fetch("/debug/auto_dose_state");
                const state = await response.json();

                document.getElementById("last-dose-time-debug").textContent = state.last_dose_time || "None";
                document.getElementById("last-dose-type-debug").textContent = state.last_dose_type || "None";
                document.getElementById("last-dose-amount-debug").textContent = state.last_dose_amount || "0";
                document.getElementById("next-dose-time-debug").textContent = state.next_dose_time || "None";
            } catch (error) {
                console.error("Error fetching auto dose state:", error);
            }
        }

        window.onload = () => {
            fetchDebugStates();
            fetchAutoDoseState();
            // Refresh auto dose state every 5 seconds
            setInterval(fetchAutoDoseState, 5000);
        };
    </script>
</head>
<body>
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/debug" class="active">Debug</a></li>
        </ul>
    </nav>

    <main>
        <h1>Debug Controls</h1>
        <p class="subtitle">Toggle debug logs for different system components.</p>

        <div class="settings-grid">
            <div class="data-container">
                <h3>Power Control</h3>
                <button id="toggle-power_control_service" class="btn-off-active" onclick="toggleDebug('power_control_service')">OFF</button>
            </div>

            <div class="data-container">
                <h3>Water Level</h3>
                <button id="toggle-water_level_service" class="btn-off-active" onclick="toggleDebug('water_level_service')">OFF</button>
            </div>

            <div class="data-container">
                <h3>Valves</h3>
                <button id="toggle-valve_relay_service" class="btn-off-active" onclick="toggleDebug('valve_relay_service')">OFF</button>
            </div>

            <div class="data-container">
                <h3>WebSocket</h3>
                <button id="toggle-websocket" class="btn-off-active" onclick="toggleDebug('websocket')">OFF</button>
            </div>

            <div class="data-container">
                <h3>pH</h3>
                <button id="toggle-ph" class="btn-off-active" onclick="toggleDebug('ph')">OFF</button>
            </div>
            <div class="data-container">
                <h3>Notifications</h3>
                <button
                  id="toggle-notifications" class="btn-off-active" onclick="toggleDebug('notifications')">OFF</button>
              </div>

            <div class="data-container">
                <h3>Status Namespace</h3>
                <button id="toggle-status_namespace" class="btn-off-active" onclick="toggleDebug('status_namespace')">OFF</button>
            </div>

            <div class="data-container">
                <h3>Auto Dosing</h3>
                <button id="toggle-auto_dosing" class="btn-off-active" onclick="toggleDebug('auto_dosing')">OFF</button>
            </div>
        </div>

        <div class="data-container" style="margin-top: 2rem;">
            <h2>Auto-Dose State (Live)</h2>
            <p><strong>Last Dose Time:</strong> <span id="last-dose-time-debug">Loading...</span></p>
            <p><strong>Last Dose Type:</strong> <span id="last-dose-type-debug">Loading...</span></p>
            <p><strong>Last Dose Amount:</strong> <span id="last-dose-amount-debug">Loading...</span> ml</p>
            <p><strong>Next Dose Time:</strong> <span id="next-dose-time-debug">Loading...</span></p>
            <p class="subtitle" style="margin-top: 1rem; font-size: 0.9rem;">Updates every 5 seconds</p>
        </div>
    </main>
</body>
</html>
