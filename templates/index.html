<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garden Monitoring System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Navigation Menu -->
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/calibration">Calibration</a></li>
            <li><a href="/configuration">Configuration</a></li>
            <li><a href="/dosage">Dosage</a></li>
            <li><a href="/settings">Settings</a></li>
            <li><a href="/valves">Valves</a></li>
        </ul>
    </nav>

    <main>
        <!-- NEW: Display System Name -->
        <h1 id="system-name-display" style="margin-bottom: 0.5rem;">Loading...</h1>

        <!-- Existing Title -->
        <h1>pH Dosing System</h1>
        <p class="subtitle">Monitor & adjust your garden’s pH with precision.</p>

        <div class="data-container" id="ph-reading-section" style="display: none;">
            <h2>Current pH Reading</h2>
            <div id="ph-display" class="data-box">Loading...</div>
        </div>

        <div class="data-container">
            <h2>Water Level Sensors</h2>
            <div id="water-level-status" class="data-box"></div>
        </div>

        <div class="data-container" id="drain-fill-section" style="display: none;">
            <h2>Drain and Fill</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                <!-- Fill Valve -->
                <div style="flex: 1;">
                    <p>Fill Valve (<span id="fill-valve-name"></span>) Status:
                        <span id="fill-valve-status">Unknown</span>
                    </p>
                    <div style="display: flex; gap: 8px;">
                        <button id="fill-valve-on"  disabled style="flex: 1;">On</button>
                        <button id="fill-valve-off" disabled style="flex: 1;">Off</button>
                    </div>
                </div>
        
                <!-- Drain Valve -->
                <div style="flex: 1;">
                    <p>Drain Valve (<span id="drain-valve-name"></span>) Status:
                        <span id="drain-valve-status">Unknown</span>
                    </p>
                    <div style="display: flex; gap: 8px;">
                        <button id="drain-valve-on"  disabled style="flex: 1;">On</button>
                        <button id="drain-valve-off" disabled style="flex: 1;">Off</button>
                    </div>
                </div>
            </div>
        </div>
        
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const socket = io("/status", {
                reconnectionAttempts: 5,
                reconnectionDelay: 2000,
                transports: ["websocket"]  // Force WebSocket transport
            });
        
            // ======================
            // 1. Fetch System Name Immediately
            // ======================
            fetchSystemName();
        
            // ======================
            // 2. WebSocket Setup
            // ======================
            socket.on('connect', () => {
                console.log("WebSocket connected successfully.");
                fetchWaterLevel();
                
                // If you prefer to conditionally fetch pH here:
                fetch('/api/settings')
                    .then(r => r.json())
                    .then(settings => {
                    if (settings.usb_roles && settings.usb_roles.ph_probe) {
                        fetchInitialPh();
                    }
                    });
                });

            socket.on('disconnect', () => {
                console.log("WebSocket disconnected.");
            });
        
            socket.on('connect_error', (error) => {
                console.error("WebSocket connection error:", error);
            });
        
            // pH updated in real-time
            socket.on('ph_update', (data) => {
                console.log("Received ph_update event:", data);
                updatePhDisplay(data.ph);
            });
        
            // General status updates (might include pH, water_level, system_name, etc.)
            socket.on('status_update', (data) => {
                console.log("Received status_update event:", data); 
                if (data.current_ph !== undefined) {
                    updatePhDisplay(data.current_ph);
                }
                if (data.water_level) {
                    renderWaterLevel(data.water_level);
                }
                if (data.system_name !== undefined) {
                    document.getElementById('system-name-display').textContent = data.system_name;
                }
            });
        
            // ======================
            // 3. Drain/Fill Logic
            // ======================
            let fillValveName = "";
            let drainValveName = "";
        
            // Fetch settings to see if water_valve_ip and fill/drain valves are defined
            fetch('/api/settings')
                .then(res => res.json())
                .then(settings => {
                    // =========== pH Container Logic ===========
                    const phSection = document.getElementById('ph-reading-section');
                    
                    // If there's no usb_roles or ph_probe is null/empty, hide the container
                    if (!settings.usb_roles || !settings.usb_roles.ph_probe) {
                    console.log("No pH probe assigned. Hiding pH reading section.");
                    phSection.style.display = 'none';
                    } else {
                    console.log("pH probe assigned. Showing pH section and fetching data...");
                    phSection.style.display = 'block';
                    // Now that we know ph_probe is assigned, fetch pH data
                    fetchInitialPh();
                    }
                    
                    // =========== Drain/Fill Logic  ===========
                    const drainFillSection = document.getElementById('drain-fill-section');

                    // 1) Check if a valve_relay device is assigned
                    if (!settings.usb_roles || !settings.usb_roles.valve_relay) {
                        console.log("No valve_relay device assigned. Hiding Drain and Fill section.");
                        // Ensure it remains hidden
                        drainFillSection.style.display = 'none';
                        return;
                    }

                    // 2) Also check if water_valve_ip + fill_valve + drain_valve are defined
                    if (settings.water_valve_ip && settings.water_fill_valve && settings.water_drain_valve) {
                        // Show the Drain/Fill section
                        drainFillSection.style.display = 'block';

                        // Update the label names for Fill/Drain
                        document.getElementById('fill-valve-name').textContent  = settings.water_fill_valve;
                        document.getElementById('drain-valve-name').textContent = settings.water_drain_valve;

                        // Fetch each valve’s status
                        fetchValveStatus(settings.water_fill_valve,  'fill-valve-status',  'fill-valve-toggle');
                        fetchValveStatus(settings.water_drain_valve, 'drain-valve-status', 'drain-valve-toggle');

                        // Attach click handlers for toggling
                        document.getElementById('fill-valve-toggle').addEventListener('click', () => {
                            toggleValve(settings.water_fill_valve, 'fill-valve-status');
                        });
                        document.getElementById('drain-valve-toggle').addEventListener('click', () => {
                            toggleValve(settings.water_drain_valve, 'drain-valve-status');
                        });

                    } else {
                        // If water_valve_ip or fill/drain valve names are missing
                        console.log("No fill/drain config found. Hiding Drain and Fill section.");
                        drainFillSection.style.display = 'none';
                    }
                })
                .catch(err => console.error('Error fetching settings:', err));

        
            // Helper to fetch a valve’s current status
            async function fetchValveStatus(valveName, statusId, buttonId) {
                try {
                    // GET /valve_relay/<valve_name>/status
                    // e.g. /valve_relay/"Zone 1 Supply"/status
                    const url = '/api/valve_relay/' + encodeURIComponent(valveName) + '/status';
                    const res = await fetch(url);
                    const data = await res.json();

                    if (data.status === 'success') {
                        // data.valve_status is "on" or "off"
                        updateValveDisplay(statusId, buttonId, data.valve_status);
                    } else {
                        console.error('Valve status error:', data.error || 'Unknown error');
                    }
                } catch (err) {
                    console.error('Error fetching valve status:', err);
                }
            }

        
            // Helper to toggle a valve on/off
            async function toggleValve(valveName, statusId) {
                try {
                    const currentSpan = document.getElementById(statusId);
                    const currentStatus = currentSpan.textContent.toLowerCase(); // "on" or "off"
                    const nextAction = (currentStatus === 'on') ? 'off' : 'on';

                    // We have two distinct endpoints:
                    //    POST /valve_relay/<valve_name>/on
                    //    POST /valve_relay/<valve_name>/off
                    const url = `/api/valve_relay/${encodeURIComponent(valveName)}/${nextAction}`;

                    const response = await fetch(url, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.status === 'success' && data.action) {
                        // The server returns { "status": "success", "valve_name": "...", "action": "on" }
                        // So data.action is "on"/"off"
                        updateValveDisplay(statusId, null, data.action);
                    } else {
                        console.error('Error toggling valve:', data.error || 'unknown');
                    }
                } catch (err) {
                    console.error('Error toggling valve:', err);
                }
            }

            // Update the display with new status
            function updateValveDisplay(statusId, buttonId, newStatus) {
                const statusSpan = document.getElementById(statusId);
                statusSpan.textContent = (newStatus.toLowerCase() === 'on') ? 'On' : 'Off';

                if (buttonId) {
                    const toggleBtn = document.getElementById(buttonId);
                    toggleBtn.disabled = false;
                }
            }

            // ======================
            // 4. Existing Helpers
            // ======================
            async function fetchInitialPh() {
                try {
                    const response = await fetch('/api/ph/latest');
                    const data = await response.json();
                    updatePhDisplay(data.ph);
                } catch (error) {
                    console.error("Error fetching pH data:", error);
                }
            }
        
            async function fetchWaterLevel() {
                try {
                    const response = await fetch('/api/water_level/');
                    const data = await response.json();
                    renderWaterLevel(data);
                } catch (error) {
                    console.error("Error fetching water level:", error);
                }
            }
        
            async function fetchSystemName() {
                try {
                    const response = await fetch('/api/settings/system_name');
                    const data = await response.json();
                    document.getElementById('system-name-display').textContent = data.system_name || 'Zone 1';
                } catch (error) {
                    console.error("Error fetching system name:", error);
                    document.getElementById('system-name-display').textContent = 'Zone 1 (Error)';
                }
            }
        
            function updatePhDisplay(ph) {
                const phDisplay = document.getElementById('ph-display');
                phDisplay.textContent = ph 
                    ? `Current pH: ${parseFloat(ph).toFixed(2)}` 
                    : "pH data unavailable";
            }
        
            function renderWaterLevel(waterLevel) {
                const container = document.getElementById('water-level-status');
                if (!waterLevel) {
                    container.innerHTML = "<p>No water-level data.</p>";
                    return;
                }
        
                const ul = document.createElement('ul');
                for (const key in waterLevel) {
                    if (waterLevel.hasOwnProperty(key)) {
                        const sensor = waterLevel[key];
                        const li = document.createElement('li');
                        li.textContent = `${sensor.label || key}: ${sensor.triggered ? "⚠️ Not Present" : "✅ Present"}`;
                        ul.appendChild(li);
                    }
                }
                container.innerHTML = "";
                container.appendChild(ul);
            }
        });
        </script>
    </body>
</html>
