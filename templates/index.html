<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garden Monitoring System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Navigation Menu -->
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/calibration">Calibration</a></li>
            <li><a href="/configuration">Configuration</a></li>
            <li><a href="/dosage">Dosage</a></li>
            <li><a href="/settings">Settings</a></li>
            <li><a href="/valves">Valves</a></li>
        </ul>
    </nav>

    <main>
        <!-- NEW: Display System Name -->
        <h1 id="system-name-display" style="margin-bottom: 0.5rem;">Loading...</h1>

        <!-- Existing Title -->
        <h1>pH Dosing System</h1>
        <p class="subtitle">Monitor & adjust your garden’s pH with precision.</p>

        <div class="data-container">
            <h2>Current pH Reading</h2>
            <div id="ph-display" class="data-box">Loading...</div>
        </div>

        <div class="data-container">
            <h2>Water Level Sensors</h2>
            <div id="water-level-status" class="data-box"></div>
        </div>

        <div class="data-container" id="drain-fill-section" style="display: none;">
            <h2>Drain and Fill</h2>
    
            <div>
                <p>Fill Valve (<span id="fill-valve-name"></span>) Status:
                    <span id="fill-valve-status">Unknown</span>
                </p>
                <button id="fill-valve-toggle" disabled>Toggle Fill Valve</button>
            </div>
    
            <div style="margin-top: 1em;">
                <p>Drain Valve (<span id="drain-valve-name"></span>) Status:
                    <span id="drain-valve-status">Unknown</span>
                </p>
                <button id="drain-valve-toggle" disabled>Toggle Drain Valve</button>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const socket = io("/status", {
                reconnectionAttempts: 5,
                reconnectionDelay: 2000,
                transports: ["websocket"]  // Force WebSocket transport
            });
        
            // ======================
            // 1. Fetch System Name Immediately
            // ======================
            fetchSystemName();
        
            // ======================
            // 2. WebSocket Setup
            // ======================
            socket.on('connect', () => {
                console.log("WebSocket connected successfully.");
                fetchInitialPh();
                fetchWaterLevel();
            });
        
            socket.on('disconnect', () => {
                console.log("WebSocket disconnected.");
            });
        
            socket.on('connect_error', (error) => {
                console.error("WebSocket connection error:", error);
            });
        
            // pH updated in real-time
            socket.on('ph_update', (data) => {
                console.log("Received ph_update event:", data);
                updatePhDisplay(data.ph);
            });
        
            // General status updates (might include pH, water_level, system_name, etc.)
            socket.on('status_update', (data) => {
                console.log("Received status_update event:", data); 
                if (data.current_ph !== undefined) {
                    updatePhDisplay(data.current_ph);
                }
                if (data.water_level) {
                    renderWaterLevel(data.water_level);
                }
                if (data.system_name !== undefined) {
                    document.getElementById('system-name-display').textContent = data.system_name;
                }
            });
        
            // ======================
            // 3. Drain/Fill Logic
            // ======================
            let fillValveName = "";
            let drainValveName = "";
        
            // Fetch settings to see if water_valve_ip and fill/drain valves are defined
            fetch('/api/settings')
                .then(res => res.json())
                .then(settings => {
                    if (settings.water_valve_ip && settings.water_fill_valve && settings.water_drain_valve) {
                        fillValveName  = settings.water_fill_valve;
                        drainValveName = settings.water_drain_valve;
        
                        // Show the Drain/Fill section
                        const drainFillSection = document.getElementById('drain-fill-section');
                        drainFillSection.style.display = 'block';
        
                        // Update the label names for Fill/Drain
                        document.getElementById('fill-valve-name').textContent  = fillValveName;
                        document.getElementById('drain-valve-name').textContent = drainValveName;
        
                        // Fetch each valve’s status
                        fetchValveStatus(fillValveName,  'fill-valve-status',  'fill-valve-toggle');
                        fetchValveStatus(drainValveName, 'drain-valve-status', 'drain-valve-toggle');
        
                        // Attach click handlers for toggling
                        document.getElementById('fill-valve-toggle').addEventListener('click', () => {
                            toggleValve(fillValveName, 'fill-valve-status');
                        });
                        document.getElementById('drain-valve-toggle').addEventListener('click', () => {
                            toggleValve(drainValveName, 'drain-valve-status');
                        });
                    }
                })
                .catch(err => console.error('Error fetching settings:', err));
        
            // Helper to fetch a valve’s current status
            async function fetchValveStatus(valveName, statusId, buttonId) {
                try {
                    const res = await fetch('/api/valves/status?valve=' + encodeURIComponent(valveName));
                    const data = await res.json();
                    // Expects { "status": "on" } or { "status": "off" }
                    if (data && typeof data.status === 'string') {
                        updateValveDisplay(statusId, buttonId, data.status);
                    }
                } catch (err) {
                    console.error('Error fetching valve status for', valveName, err);
                }
            }
        
            // Helper to toggle a valve on/off
            async function toggleValve(valveName, statusId) {
                try {
                    // Get current status from the DOM to decide next action
                    const currentSpan = document.getElementById(statusId);
                    const currentStatus = currentSpan.textContent.toLowerCase(); // "On" or "Off"
                    const nextAction = (currentStatus === 'on') ? 'off' : 'on';
        
                    const response = await fetch('/api/valves/toggle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            valve: valveName,
                            action: nextAction
                        })
                    });
        
                    const data = await response.json();
                    if (data && typeof data.status === 'string') {
                        // Update the UI with the new status
                        updateValveDisplay(statusId, null, data.status);
                    }
                } catch (err) {
                    console.error('Error toggling valve:', err);
                }
            }
        
            // Update the display with new status
            function updateValveDisplay(statusId, buttonId, newStatus) {
                const statusSpan = document.getElementById(statusId);
                statusSpan.textContent = (newStatus.toLowerCase() === 'on') ? 'On' : 'Off';
        
                // Enable the toggle button once we know the status
                if (buttonId) {
                    const toggleBtn = document.getElementById(buttonId);
                    toggleBtn.disabled = false;
                }
            }
        
            // ======================
            // 4. Existing Helpers
            // ======================
            async function fetchInitialPh() {
                try {
                    const response = await fetch('/api/ph/latest');
                    const data = await response.json();
                    updatePhDisplay(data.ph);
                } catch (error) {
                    console.error("Error fetching pH data:", error);
                }
            }
        
            async function fetchWaterLevel() {
                try {
                    const response = await fetch('/api/water_level/');
                    const data = await response.json();
                    renderWaterLevel(data);
                } catch (error) {
                    console.error("Error fetching water level:", error);
                }
            }
        
            async function fetchSystemName() {
                try {
                    const response = await fetch('/api/settings/system_name');
                    const data = await response.json();
                    document.getElementById('system-name-display').textContent = data.system_name || 'Zone 1';
                } catch (error) {
                    console.error("Error fetching system name:", error);
                    document.getElementById('system-name-display').textContent = 'Zone 1 (Error)';
                }
            }
        
            function updatePhDisplay(ph) {
                const phDisplay = document.getElementById('ph-display');
                phDisplay.textContent = ph 
                    ? `Current pH: ${parseFloat(ph).toFixed(2)}` 
                    : "pH data unavailable";
            }
        
            function renderWaterLevel(waterLevel) {
                const container = document.getElementById('water-level-status');
                if (!waterLevel) {
                    container.innerHTML = "<p>No water-level data.</p>";
                    return;
                }
        
                const ul = document.createElement('ul');
                for (const key in waterLevel) {
                    if (waterLevel.hasOwnProperty(key)) {
                        const sensor = waterLevel[key];
                        const li = document.createElement('li');
                        li.textContent = `${sensor.label || key}: ${sensor.triggered ? "⚠️ Not Present" : "✅ Present"}`;
                        ul.appendChild(li);
                    }
                }
                container.innerHTML = "";
                container.appendChild(ul);
            }
        });
        </script>
    </body>
</html>
