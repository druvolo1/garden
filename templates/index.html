<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Garden Monitoring System</title>
  
  <!-- Link to your existing style.css, which has .btn-on-active, .btn-off-active, etc. -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- jQuery and Socket.IO -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <!-- Google font (Poppins) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Navigation Menu -->
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/calibration">Calibration</a></li>
      <li><a href="/configuration">Configuration</a></li>
      <li><a href="/dosage">Dosage</a></li>
      <li><a href="/settings">Settings</a></li>
      <li><a href="/valves">Valves</a></li>
    </ul>
  </nav>

  <main>
    <h1>pH Dosing System</h1>
    <p class="subtitle">Monitor &amp; adjust your garden’s pH with precision.</p>

    <!-- Local Zone -->
    <section class="data-container">
      <h2>Local Zone</h2>
      <div class="row-flex">
        <!-- System Name -->
        <div>
          <label>System Name</label>
          <div id="local-system-name">Loading...</div>
        </div>

        <!-- pH -->
        <div>
          <label>pH</label>
          <div id="local-ph-display">Loading...</div>
        </div>

        <!-- EC -->
        <div>
          <label>EC (mS/cm)</label>
          <div id="local-ec-display">N/A</div>
        </div>

        <!-- Sensor #1 -->
        <div>
          <label>Sensor 1</label>
          <div id="local-sensor1-display">Loading...</div>
        </div>
        <!-- Sensor #2 -->
        <div>
          <label>Sensor 2</label>
          <div id="local-sensor2-display">Loading...</div>
        </div>
        <!-- Sensor #3 -->
        <div>
          <label>Sensor 3</label>
          <div id="local-sensor3-display">Loading...</div>
        </div>

        <!-- Fill Valve -->
        <div id="local-fill-container" style="display:none;">
          <label>Fill Valve: <span id="local-fill-status">Off</span></label>
          <div style="display:flex; gap:8px; margin-top:4px;">
            <!-- We'll color-code these with .btn-on-active, .btn-off-active, etc. -->
            <button id="local-fill-on" disabled>On</button>
            <button id="local-fill-off" disabled>Off</button>
          </div>
        </div>

        <!-- Drain Valve -->
        <div id="local-drain-container" style="display:none;">
          <label>Drain Valve: <span id="local-drain-status">Off</span></label>
          <div style="display:flex; gap:8px; margin-top:4px;">
            <button id="local-drain-on" disabled>On</button>
            <button id="local-drain-off" disabled>Off</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Container for additional plants (remote zones) -->
    <div id="remote-zones"></div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // 1) Connect to the local status namespace
      const localSocket = io("/status", {
        transports: ["websocket"],
        reconnectionAttempts: 5,
        reconnectionDelay: 2000
      });

      localSocket.on("connect", () => {
        console.log("[LOCAL] Socket connected");
      });

      localSocket.on("disconnect", () => {
        console.log("[LOCAL] Socket disconnected");
      });

      localSocket.on("connect_error", (err) => {
        console.error("[LOCAL] connect_error:", err);
      });

      // On each status_update, we refresh the local zone's info
      localSocket.on("status_update", (data) => {
        console.log("[LOCAL] status_update:", data);

        // A) Basic System info
        if (data.settings?.system_name) {
          document.getElementById("local-system-name").textContent = data.settings.system_name;
        }
        if (data.current_ph !== undefined) {
          document.getElementById("local-ph-display").textContent = parseFloat(data.current_ph).toFixed(2);
        } else {
          document.getElementById("local-ph-display").textContent = "N/A";
        }
        if (data.current_ec !== undefined) {
          document.getElementById("local-ec-display").textContent = parseFloat(data.current_ec).toFixed(2);
        } else {
          document.getElementById("local-ec-display").textContent = "N/A";
        }

        // B) Water Level sensors
        if (data.water_level && data.settings?.water_level_sensors) {
          renderSensors("local", data.settings.water_level_sensors, data.water_level);
        }

        // C) Valve config from settings
        const fillValveName  = data.settings?.fill_valve;
        const drainValveName = data.settings?.drain_valve;
        const fillValveIp    = data.settings?.fill_valve_ip  || window.location.hostname;
        const drainValveIp   = data.settings?.drain_valve_ip || window.location.hostname;

        // Show or hide the fill/drain container if we have them
        document.getElementById("local-fill-container").style.display  = fillValveName ? "block" : "none";
        document.getElementById("local-drain-container").style.display = drainValveName ? "block" : "none";

        // Enable or disable the On/Off buttons
        const fillOnBtn  = document.getElementById("local-fill-on");
        const fillOffBtn = document.getElementById("local-fill-off");
        const drainOnBtn = document.getElementById("local-drain-on");
        const drainOffBtn= document.getElementById("local-drain-off");

        fillOnBtn.disabled   = !fillValveName;
        fillOffBtn.disabled  = !fillValveName;
        drainOnBtn.disabled  = !drainValveName;
        drainOffBtn.disabled = !drainValveName;

        // If not set, define the onClick handlers for local toggles
        if (!fillOnBtn.onclick) {
          fillOnBtn.onclick   = () => setValveLocal(fillValveIp,  fillValveName,  "local-fill-status",  "on");
          fillOffBtn.onclick  = () => setValveLocal(fillValveIp,  fillValveName,  "local-fill-status",  "off");
          drainOnBtn.onclick  = () => setValveLocal(drainValveIp, drainValveName, "local-drain-status", "on");
          drainOffBtn.onclick = () => setValveLocal(drainValveIp, drainValveName, "local-drain-status", "off");
        }

        // D) If the server passes real-time statuses in data.valve_info.valve_relays, update UI
        if (data.valve_info?.valve_relays) {
          const relays = data.valve_info.valve_relays; 
          // Possibly we match them by numeric ID or by label. 
          // The sample code here matches them by label from your settings, if you prefer:
          const fillLabel  = data.settings?.valve_labels?.[fillValveName]  || fillValveName;
          const drainLabel = data.settings?.valve_labels?.[drainValveName] || drainValveName;

          for (let rId in relays) {
            const rInfo = relays[rId];
            const rLabel = rInfo.label;
            const rStatus = rInfo.status.toLowerCase();

            // If matches fill label
            if (rLabel && rLabel === fillLabel) {
              document.getElementById("local-fill-status").textContent = (rStatus === "on") ? "On" : "Off";
              updateLocalValveButtons("fill", rStatus);
            }
            // If matches drain label
            if (rLabel && rLabel === drainLabel) {
              document.getElementById("local-drain-status").textContent = (rStatus === "on") ? "On" : "Off";
              updateLocalValveButtons("drain", rStatus);
            }
          }
        }
      });

      // 2) Load local settings once to find additional_plants (remote hosts)
      fetch("/api/settings")
        .then(r => r.json())
        .then(settings => {
          const extra = settings.additional_plants || [];
          extra.forEach(host => {
            setupRemoteZone(host);
          });
        })
        .catch(err => console.error("[LOCAL] error loading additional_plants:", err));
    });

    // Renders sensor data for local or remote
    function renderSensors(prefix, sensorDefs, waterLevel) {
      for (let i = 1; i <= 3; i++) {
        const sensorKey = `sensor${i}`;
        const labelKey  = sensorDefs[sensorKey]?.label || `Sensor ${i}`;
        const triggered = waterLevel[sensorKey]?.triggered ?? null;
        const displayEl = document.getElementById(`${prefix}-sensor${i}-display`);
        if (!displayEl) continue;

        if (triggered === null) {
          displayEl.textContent = `${labelKey}: No Data`;
        } else {
          displayEl.textContent = `${labelKey}: ` + (triggered ? "⚠️ Not Present" : "✅ Present");
        }
      }
    }

    // Called when user toggles local fill/drain
    function setValveLocal(host, valveName, statusSpanId, action) {
      if (!valveName) return;
      const url = `http://${host}:8000/api/valve_relay/${encodeURIComponent(valveName)}/${action}`;
      fetch(url, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.status === "success") {
            // Optimistic UI update
            updateValveStatusUI(statusSpanId, action);
          } else {
            console.error("[LOCAL] Valve error:", data.error);
          }
        })
        .catch(err => console.error("[LOCAL] Valve fetch error:", err));
    }

    // Immediately update the text (and color-coded buttons) 
    function updateValveStatusUI(spanId, action) {
      const span = document.getElementById(spanId);
      if (span) {
        span.textContent = (action === "on") ? "On" : "Off";
      }
      // "fill" or "drain" 
      const prefix = spanId.includes("fill") ? "fill" : "drain";
      updateLocalValveButtons(prefix, action);
    }

    // Use the .btn-on-active / .btn-off-active classes for local fill/drain
    function updateLocalValveButtons(valvePrefix, newStatus) {
      // newStatus is "on"/"off"
      const onBtn  = document.getElementById(`local-${valvePrefix}-on`);
      const offBtn = document.getElementById(`local-${valvePrefix}-off`);
      if (!onBtn || !offBtn) return;

      // Clear old classes
      onBtn.classList.remove("btn-on-active","btn-off-active","btn-inactive");
      offBtn.classList.remove("btn-on-active","btn-off-active","btn-inactive");

      if (newStatus === "on") {
        onBtn.classList.add("btn-on-active");
        offBtn.classList.add("btn-inactive");
      } else {
        onBtn.classList.add("btn-inactive");
        offBtn.classList.add("btn-off-active");
      }
    }

    // ----------------- Remote Zones -----------------
    function setupRemoteZone(host) {
      // create a section for each remote
      const zoneId = host.replace(/[^a-zA-Z0-9]/g, "_");
      const container = document.createElement("section");
      container.className = "data-container";
      container.innerHTML = `
        <h2>Remote Zone: <a href="http://${host}:8000" target="_blank">${host}</a></h2>
        <div class="row-flex" id="${zoneId}-row">
          <div>
            <label>System Name</label>
            <div id="${zoneId}-system-name">Loading...</div>
          </div>
          <div>
            <label>pH</label>
            <div id="${zoneId}-ph-display">Loading...</div>
          </div>
          <div>
            <label>EC (mS/cm)</label>
            <div id="${zoneId}-ec-display">N/A</div>
          </div>
          <div>
            <label>Sensor 1</label>
            <div id="${zoneId}-sensor1-display">Loading...</div>
          </div>
          <div>
            <label>Sensor 2</label>
            <div id="${zoneId}-sensor2-display">Loading...</div>
          </div>
          <div>
            <label>Sensor 3</label>
            <div id="${zoneId}-sensor3-display">Loading...</div>
          </div>
          <div style="display:none;" id="${zoneId}-fill-container">
            <label>Fill Valve: <span id="${zoneId}-fill-status">Off</span></label>
            <div style="display:flex; gap:8px; margin-top:4px;">
              <button id="${zoneId}-fill-on" disabled>On</button>
              <button id="${zoneId}-fill-off" disabled>Off</button>
            </div>
          </div>
          <div style="display:none;" id="${zoneId}-drain-container">
            <label>Drain Valve: <span id="${zoneId}-drain-status">Off</span></label>
            <div style="display:flex; gap:8px; margin-top:4px;">
              <button id="${zoneId}-drain-on" disabled>On</button>
              <button id="${zoneId}-drain-off" disabled>Off</button>
            </div>
          </div>
        </div>
      `;
      document.getElementById("remote-zones").appendChild(container);

      const remoteUrl = `http://${host}:8000/status`;
      console.log(`[REMOTE] Connecting to ${remoteUrl}`);
      const remoteSocket = io(remoteUrl, {
        transports:["websocket"],
        reconnectionAttempts:5,
        reconnectionDelay:2000
      });

      remoteSocket.on("connect", () => {
        console.log(`[REMOTE ${host}] connected`);
      });
      remoteSocket.on("disconnect", () => {
        console.log(`[REMOTE ${host}] disconnected`);
      });
      remoteSocket.on("connect_error", (err) => {
        console.error(`[REMOTE ${host}] connect_error:`, err);
      });

      // For each remote zone's status_update, we do the same steps
      remoteSocket.on("status_update", (data) => {
        console.log(`[REMOTE ${host}] status_update:`, data);

        // Basic info
        if (data.settings?.system_name) {
          document.getElementById(`${zoneId}-system-name`).textContent = data.settings.system_name;
        }
        if (data.current_ph !== undefined) {
          document.getElementById(`${zoneId}-ph-display`).textContent =
            parseFloat(data.current_ph).toFixed(2);
        } else {
          document.getElementById(`${zoneId}-ph-display`).textContent = "N/A";
        }
        if (data.current_ec !== undefined) {
          document.getElementById(`${zoneId}-ec-display`).textContent =
            parseFloat(data.current_ec).toFixed(2);
        } else {
          document.getElementById(`${zoneId}-ec-display`).textContent = "N/A";
        }

        if (data.settings?.water_level_sensors && data.water_level) {
          renderSensors(zoneId, data.settings.water_level_sensors, data.water_level);
        }

        // Now handle the remote fill/drain
        const fillValveName  = data.settings?.fill_valve;
        const drainValveName = data.settings?.drain_valve;
        const fillValveIp    = data.valve_info?.fill_valve_ip  || host;
        const drainValveIp   = data.valve_info?.drain_valve_ip || host;

        // Show or hide
        document.getElementById(`${zoneId}-fill-container`).style.display  = fillValveName ? "block" : "none";
        document.getElementById(`${zoneId}-drain-container`).style.display = drainValveName ? "block" : "none";

        const fillOnBtn  = document.getElementById(`${zoneId}-fill-on`);
        const fillOffBtn = document.getElementById(`${zoneId}-fill-off`);
        const drainOnBtn = document.getElementById(`${zoneId}-drain-on`);
        const drainOffBtn= document.getElementById(`${zoneId}-drain-off`);

        fillOnBtn.disabled   = !fillValveName;
        fillOffBtn.disabled  = !fillValveName;
        drainOnBtn.disabled  = !drainValveName;
        drainOffBtn.disabled = !drainValveName;

        // If not set, define the remote onClick
        if (!fillOnBtn.onclick) {
          fillOnBtn.onclick   = () => remoteSetValve(fillValveIp,  fillValveName,  `${zoneId}-fill-status`,  "on", zoneId, "fill");
          fillOffBtn.onclick  = () => remoteSetValve(fillValveIp,  fillValveName,  `${zoneId}-fill-status`,  "off", zoneId, "fill");
          drainOnBtn.onclick  = () => remoteSetValve(drainValveIp, drainValveName, `${zoneId}-drain-status`, "on", zoneId, "drain");
          drainOffBtn.onclick = () => remoteSetValve(drainValveIp, drainValveName,`${zoneId}-drain-status`, "off", zoneId, "drain");
        }

        // If we have valve_relays, let's parse them to see actual on/off states
        if (data.valve_info?.valve_relays) {
          const relays = data.valve_info.valve_relays;
          const fillLabel  = data.settings?.valve_labels?.[fillValveName]  || fillValveName;
          const drainLabel = data.settings?.valve_labels?.[drainValveName] || drainValveName;

          for (let rId in relays) {
            const rInfo = relays[rId];
            const rStatus = rInfo.status.toLowerCase();
            const rLabel = rInfo.label;

            if (rLabel && rLabel === fillLabel) {
              document.getElementById(`${zoneId}-fill-status`).textContent = (rStatus === "on") ? "On" : "Off";
              updateRemoteValveButtons(zoneId, "fill", rStatus);
            }
            if (rLabel && rLabel === drainLabel) {
              document.getElementById(`${zoneId}-drain-status`).textContent = (rStatus === "on") ? "On" : "Off";
              updateRemoteValveButtons(zoneId, "drain", rStatus);
            }
          }
        }
      });
    }

    // We color-code remote fill/drain the same way as local
    function remoteSetValve(host, valveName, statusSpanId, action, zoneId, valvePrefix) {
      const url = `http://${host}:8000/api/valve_relay/${encodeURIComponent(valveName)}/${action}`;
      fetch(url, { method:'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.status === "success") {
            // Optimistic update
            document.getElementById(statusSpanId).textContent = (action === "on") ? "On" : "Off";
            updateRemoteValveButtons(zoneId, valvePrefix, action);
          } else {
            console.error(`[REMOTE ${host}] valve error:`, data.error);
          }
        })
        .catch(err => console.error(`[REMOTE ${host}] valve fetch error:`, err));
    }

    function updateRemoteValveButtons(zoneId, valvePrefix, newStatus) {
      const onBtn  = document.getElementById(`${zoneId}-${valvePrefix}-on`);
      const offBtn = document.getElementById(`${zoneId}-${valvePrefix}-off`);
      if (!onBtn || !offBtn) return;

      onBtn.classList.remove("btn-on-active","btn-off-active","btn-inactive");
      offBtn.classList.remove("btn-on-active","btn-off-active","btn-inactive");

      if (newStatus === "on") {
        onBtn.classList.add("btn-on-active");
        offBtn.classList.add("btn-inactive");
      } else {
        onBtn.classList.add("btn-inactive");
        offBtn.classList.add("btn-off-active");
      }
    }
  </script>
</body>
</html>
