<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- 1) Viewport meta tag for mobile responsiveness -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Garden Monitoring System</title>
  
  <!-- Link to your updated style.css -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  
  <!-- jQuery and Socket.IO (unchanged from your original) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <!-- Google font (Poppins) -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Navigation Menu -->
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/calibration">Calibration</a></li>
      <li><a href="/configuration">Configuration</a></li>
      <li><a href="/dosage">Dosage</a></li>
      <li><a href="/settings">Settings</a></li>
      <li><a href="/valves">Valves</a></li>
    </ul>
  </nav>

  <main>
    <h1>pH Dosing System</h1>
    <p class="subtitle">Monitor &amp; adjust your garden’s pH with precision.</p>

    <!-- Local Zone -->
    <section class="data-container">
      <h2>Local Zone</h2>
      <!-- 2) Use a row-flex container to group these items in a responsive row -->
      <div class="row-flex">
        <!-- System Name -->
        <div>
          <label>System Name</label>
          <div id="local-system-name">Loading...</div>
        </div>

        <!-- pH -->
        <div>
          <label>pH</label>
          <div id="local-ph-display">Loading...</div>
        </div>

        <!-- EC -->
        <div>
          <label>EC (mS/cm)</label>
          <div id="local-ec-display">N/A</div>
        </div>

        <!-- Sensor #1 -->
        <div>
          <label>Sensor 1</label>
          <div id="local-sensor1-display">Loading...</div>
        </div>

        <!-- Sensor #2 -->
        <div>
          <label>Sensor 2</label>
          <div id="local-sensor2-display">Loading...</div>
        </div>

        <!-- Sensor #3 -->
        <div>
          <label>Sensor 3</label>
          <div id="local-sensor3-display">Loading...</div>
        </div>

        <!-- Fill Valve -->
        <div id="local-fill-container" style="display:none;">
          <label>Fill Valve: <span id="local-fill-status">Off</span></label>
          <div style="display:flex; gap:8px; margin-top:4px;">
            <button id="local-fill-on" disabled>On</button>
            <button id="local-fill-off" disabled>Off</button>
          </div>
        </div>

        <!-- Drain Valve -->
        <div id="local-drain-container" style="display:none;">
          <label>Drain Valve: <span id="local-drain-status">Off</span></label>
          <div style="display:flex; gap:8px; margin-top:4px;">
            <button id="local-drain-on" disabled>On</button>
            <button id="local-drain-off" disabled>Off</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Container for additional plants (remote zones) -->
    <div id="remote-zones"></div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // 1) Connect local socket
      const localSocket = io("/status", {
        transports: ["websocket"],
        reconnectionAttempts: 5,
        reconnectionDelay: 2000
      });

      localSocket.on("connect", () => {
        console.log("[LOCAL] Socket connected");
      });

      localSocket.on("disconnect", () => {
        console.log("[LOCAL] Socket disconnected");
      });

      localSocket.on("connect_error", (err) => {
        console.error("[LOCAL] connect_error:", err);
      });

      // On each "status_update", we get data with: settings, current_ph, etc.
      localSocket.on("status_update", (data) => {
        console.log("[LOCAL] status_update:", data);

        // A) System Name
        if (data.settings && data.settings.system_name) {
          document.getElementById("local-system-name").textContent = data.settings.system_name;
        }

        // B) pH
        if (data.current_ph !== undefined) {
          document.getElementById("local-ph-display").textContent = parseFloat(data.current_ph).toFixed(2);
        } else {
          document.getElementById("local-ph-display").textContent = "N/A";
        }

        // C) EC
        if (data.current_ec !== undefined) {
          document.getElementById("local-ec-display").textContent = parseFloat(data.current_ec).toFixed(2);
        } else {
          document.getElementById("local-ec-display").textContent = "N/A";
        }

        // D) Water Level
        if (data.water_level && data.settings && data.settings.water_level_sensors) {
          renderSensors("local", data.settings.water_level_sensors, data.water_level);
        }

        // E) Valves
        if (data.settings) {
          const fillValveName  = data.settings.fill_valve;
          const drainValveName = data.settings.drain_valve;
          const fillHost       = data.settings.fill_valve_ip  || window.location.hostname;
          const drainHost      = data.settings.drain_valve_ip || window.location.hostname;

          if (fillValveName || drainValveName) {
            document.getElementById("local-fill-container").style.display = fillValveName ? "block" : "none";
            document.getElementById("local-drain-container").style.display = drainValveName ? "block" : "none";

            const fillOnBtn   = document.getElementById("local-fill-on");
            const fillOffBtn  = document.getElementById("local-fill-off");
            const drainOnBtn  = document.getElementById("local-drain-on");
            const drainOffBtn = document.getElementById("local-drain-off");

            fillOnBtn.disabled   = !fillValveName;
            fillOffBtn.disabled  = !fillValveName;
            drainOnBtn.disabled  = !drainValveName;
            drainOffBtn.disabled = !drainValveName;

            // Attach event handlers if not already attached
            if (!fillOnBtn.onclick) {
              fillOnBtn.onclick   = () => setValveLocal(fillHost,  fillValveName,  "local-fill-status",  "on");
              fillOffBtn.onclick  = () => setValveLocal(fillHost,  fillValveName,  "local-fill-status",  "off");
              drainOnBtn.onclick  = () => setValveLocal(drainHost, drainValveName, "local-drain-status", "on");
              drainOffBtn.onclick = () => setValveLocal(drainHost, drainValveName, "local-drain-status", "off");
            }
          }
        }
      });

      // 2) Load the local settings once to find additional_plants
      fetch("/api/settings")
        .then(r => r.json())
        .then(settings => {
          const extra = settings.additional_plants || [];
          if (extra.length > 0) {
            extra.forEach(host => {
              setupRemoteZone(host);
            });
          }
        })
        .catch(err => console.error("[LOCAL] error loading additional_plants:", err));
    });

    function renderSensors(prefix, sensorDefs, waterLevel) {
      for (let i = 1; i <= 3; i++) {
        const sensorKey = `sensor${i}`;
        const labelKey  = sensorDefs[sensorKey] ? sensorDefs[sensorKey].label : `Sensor ${i}`;
        const triggered = waterLevel[sensorKey] ? waterLevel[sensorKey].triggered : null;

        const displayEl = document.getElementById(`${prefix}-sensor${i}-display`);
        if (!displayEl) continue;

        if (triggered === null) {
          displayEl.textContent = `${labelKey}: No Data`;
        } else {
          displayEl.textContent = `${labelKey}: ` + (triggered ? "⚠️ Not Present" : "✅ Present");
        }
      }
    }

    function setValveLocal(host, valveName, statusSpanId, action) {
      if (!valveName) return;
      const url = `http://${host}:8000/api/valve_relay/${encodeURIComponent(valveName)}/${action}`;
      fetch(url, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.status === "success") {
            updateValveStatusUI(statusSpanId, action);
          } else {
            console.error("[LOCAL] Valve error:", data.error);
          }
        })
        .catch(err => console.error("[LOCAL] Valve fetch error:", err));
    }

    function updateValveStatusUI(spanId, action) {
      const span = document.getElementById(spanId);
      if (!span) return;
      span.textContent = (action === "on") ? "On" : "Off";
    }

    // Remote zones
    function setupRemoteZone(host) {
      // 1) Build UI container
      const zoneId = host.replace(/[^a-zA-Z0-9]/g, "_");
      const container = document.createElement("section");
      container.className = "data-container";
      container.innerHTML = `
        <h2>Remote Zone: <a href="http://${host}:8000" target="_blank">${host}</a></h2>
        <div class="row-flex" id="${zoneId}-row">
          <div>
            <label>System Name</label>
            <div id="${zoneId}-system-name">Loading...</div>
          </div>
          <div>
            <label>pH</label>
            <div id="${zoneId}-ph-display">Loading...</div>
          </div>
          <div>
            <label>EC (mS/cm)</label>
            <div id="${zoneId}-ec-display">N/A</div>
          </div>
          <div>
            <label>Sensor 1</label>
            <div id="${zoneId}-sensor1-display">Loading...</div>
          </div>
          <div>
            <label>Sensor 2</label>
            <div id="${zoneId}-sensor2-display">Loading...</div>
          </div>
          <div>
            <label>Sensor 3</label>
            <div id="${zoneId}-sensor3-display">Loading...</div>
          </div>
          <div style="display:none;" id="${zoneId}-fill-container">
            <label>Fill Valve: <span id="${zoneId}-fill-status">Off</span></label>
            <div style="display:flex; gap:8px; margin-top:4px;">
              <button id="${zoneId}-fill-on" disabled>On</button>
              <button id="${zoneId}-fill-off" disabled>Off</button>
            </div>
          </div>
          <div style="display:none;" id="${zoneId}-drain-container">
            <label>Drain Valve: <span id="${zoneId}-drain-status">Off</span></label>
            <div style="display:flex; gap:8px; margin-top:4px;">
              <button id="${zoneId}-drain-on" disabled>On</button>
              <button id="${zoneId}-drain-off" disabled>Off</button>
            </div>
          </div>
        </div>
      `;
      document.getElementById("remote-zones").appendChild(container);

      // 2) Connect socket
      const remoteUrl = `http://${host}:8000/status`;
      console.log(`[REMOTE] Connecting to ${remoteUrl}`);
      const remoteSocket = io(remoteUrl, {
        transports:["websocket"],
        reconnectionAttempts:5,
        reconnectionDelay:2000
      });

      remoteSocket.on("connect", () => {
        console.log(`[REMOTE ${host}] connected`);
      });

      remoteSocket.on("disconnect", () => {
        console.log(`[REMOTE ${host}] disconnected`);
      });

      remoteSocket.on("connect_error", (err) => {
        console.error(`[REMOTE ${host}] connect_error:`, err);
      });

      remoteSocket.on("status_update", (data) => {
        console.log(`[REMOTE ${host}] status_update:`, data);

        // System name
        if (data.settings && data.settings.system_name) {
          document.getElementById(`${zoneId}-system-name`).textContent = data.settings.system_name;
        }

        // pH
        if (data.current_ph !== undefined) {
          document.getElementById(`${zoneId}-ph-display`).textContent =
            parseFloat(data.current_ph).toFixed(2);
        } else {
          document.getElementById(`${zoneId}-ph-display`).textContent = "N/A";
        }

        // EC
        if (data.current_ec !== undefined) {
          document.getElementById(`${zoneId}-ec-display`).textContent =
            parseFloat(data.current_ec).toFixed(2);
        } else {
          document.getElementById(`${zoneId}-ec-display`).textContent = "N/A";
        }

        // Water level sensors
        if (data.settings && data.settings.water_level_sensors && data.water_level) {
          renderSensors(zoneId, data.settings.water_level_sensors, data.water_level);
        }

        // Valves
        if (data.valve_info) {
          document.getElementById(`${zoneId}-fill-container`).style.display = "block";
          document.getElementById(`${zoneId}-drain-container`).style.display = "block";

          const fillOnBtn   = document.getElementById(`${zoneId}-fill-on`);
          const fillOffBtn  = document.getElementById(`${zoneId}-fill-off`);
          const drainOnBtn  = document.getElementById(`${zoneId}-drain-on`);
          const drainOffBtn = document.getElementById(`${zoneId}-drain-off`);

          fillOnBtn.disabled  = false;
          fillOffBtn.disabled = false;
          drainOnBtn.disabled  = false;
          drainOffBtn.disabled = false;

          const fillValveName  = data.valve_info.fill_valve;
          const drainValveName = data.valve_info.drain_valve;

          const remoteFillHost  = data.valve_info.fill_valve_ip  || host;
          const remoteDrainHost = data.valve_info.drain_valve_ip || host;

          if (!fillOnBtn.onclick) {
            fillOnBtn.onclick   = () => remoteSetValve(remoteFillHost,  fillValveName,  `${zoneId}-fill-status`,  "on");
            fillOffBtn.onclick  = () => remoteSetValve(remoteFillHost,  fillValveName,  `${zoneId}-fill-status`,  "off");
            drainOnBtn.onclick  = () => remoteSetValve(remoteDrainHost, drainValveName, `${zoneId}-drain-status`, "on");
            drainOffBtn.onclick = () => remoteSetValve(remoteDrainHost, drainValveName, `${zoneId}-drain-status`, "off");
          }
        }
      });
    }

    function remoteSetValve(host, valveName, statusSpanId, action) {
      const url = `http://${host}:8000/api/valve_relay/${encodeURIComponent(valveName)}/${action}`;
      fetch(url, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.status === "success") {
            document.getElementById(statusSpanId).textContent = (action === "on") ? "On" : "Off";
          } else {
            console.error(`[REMOTE ${host}] valve error:`, data.error);
          }
        })
        .catch(err => console.error(`[REMOTE ${host}] valve fetch error:`, err));
    }
  </script>
</body>
</html>
